<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 13.1.1"/>
    <title>escapecalculator API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>




            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#EscapeCalculator">EscapeCalculator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#EscapeCalculator.__init__">EscapeCalculator</a>
                        </li>
                        <li>
                                <a class="function" href="#EscapeCalculator.escape_per_site">escape_per_site</a>
                        </li>
                        <li>
                                <a class="function" href="#EscapeCalculator.binding_retained">binding_retained</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
escapecalculator    </h1>

                        <div class="docstring"><p>Calculate escape after some mutations to the SARS-CoV-2 RBD.</p>

<p>This Python module, is available at
<a href="https://github.com/jbloomlab/SARS2-RBD-escape-calc/blob/main/escapecalculator.py">https://github.com/jbloomlab/SARS2-RBD-escape-calc/blob/main/escapecalculator.py</a></p>

<p>It provides a programmatic method to perform the escape calculations implemented in
the interactive calculator implemented at
<a href="https://jbloomlab.github.io/SARS2-RBD-escape-calc">https://jbloomlab.github.io/SARS2-RBD-escape-calc</a></p>

<p>By default, it downloads the same data used by the interactive calculator and uses the
same initial parameter settings as the interactive calculator. You can override these
defaults by using different arguments when initializing the <code><a href="#EscapeCalculator">EscapeCalculator</a></code>.</p>

<p>See <a href="https://github.com/jbloomlab/SARS2-RBD-escape-calc">https://github.com/jbloomlab/SARS2-RBD-escape-calc</a> for all code and data. The
calculator is written by Jesse Bloom, and the citation is
<a href="https://doi.org/10.1093/ve/veac021">this paper </a>.</p>

<p>To use the calculator, open a Python session, import this module, and initialize an
<code><a href="#EscapeCalculator">EscapeCalculator</a></code>:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">calc</span> <span class="o">=</span> <span class="n">EscapeCalculator</span><span class="p">()</span>
</code></pre>
</div>

<p>With no mutations, there is no escape (all neutralization retained):</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">calc</span><span class="o">.</span><span class="n">binding_retained</span><span class="p">([])</span> <span class="o">==</span> <span class="mf">1.0</span>
</code></pre>
</div>

<p>But if you mutate some key antigenic sites, there will be a dramatic reduction in
neutralization retained:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">calc</span><span class="o">.</span><span class="n">binding_retained</span><span class="p">([</span><span class="mi">440</span><span class="p">,</span> <span class="mi">505</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.545</span>
</code></pre>
</div>

<p>If you have a whole set of sequences and have tabulated which sites are mutated,
you can apply the calculator in bulk to the data frame.
First, create such a data frame of sequences:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">seqs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">[(</span><span class="s2">&quot;seq1&quot;</span><span class="p">,</span> <span class="p">[]),</span> <span class="p">(</span><span class="s2">&quot;seq2&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">498</span><span class="p">]),</span> <span class="p">(</span><span class="s2">&quot;seq3&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">440</span><span class="p">]),</span> <span class="p">(</span><span class="s2">&quot;seq4&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">440</span><span class="p">,</span> <span class="mi">505</span><span class="p">])],</span>
<span class="gp">... </span>    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;mutated sites&quot;</span><span class="p">],</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">seqs</span>
<span class="go">   name mutated sites</span>
<span class="go">0  seq1            []</span>
<span class="go">1  seq2         [498]</span>
<span class="go">2  seq3         [440]</span>
<span class="go">3  seq4    [440, 505]</span>
</code></pre>
</div>

<p>Now apply the calculator:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">seqs</span><span class="p">[</span><span class="s2">&quot;neutralization retained&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seqs</span><span class="p">[</span><span class="s2">&quot;mutated sites&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">binding_retained</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">seqs</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">   name mutated sites  neutralization retained</span>
<span class="go">0  seq1            []                    1.000</span>
<span class="go">1  seq2         [498]                    0.769</span>
<span class="go">2  seq3         [440]                    0.790</span>
<span class="go">3  seq4    [440, 505]                    0.545</span>
</code></pre>
</div>

<p>You can also create new calculators that compute escape relative to different viruses,
for instance BA.2:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">calc_ba2</span> <span class="o">=</span> <span class="n">EscapeCalculator</span><span class="p">(</span><span class="n">virus</span><span class="o">=</span><span class="s2">&quot;BA.2&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>Now the escape will be different because different antibodies neutralize that virus:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">calc_ba2</span><span class="o">.</span><span class="n">binding_retained</span><span class="p">([</span><span class="mi">440</span><span class="p">,</span> <span class="mi">505</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.786</span>
</code></pre>
</div>
</div>

                        <input id="mod-escapecalculator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-escapecalculator-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;Calculate escape after some mutations to the SARS-CoV-2 RBD.</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">This Python module, is available at</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="sd">https://github.com/jbloomlab/SARS2-RBD-escape-calc/blob/main/escapecalculator.py</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">It provides a programmatic method to perform the escape calculations implemented in</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">the interactive calculator implemented at</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">https://jbloomlab.github.io/SARS2-RBD-escape-calc</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="sd">By default, it downloads the same data used by the interactive calculator and uses the</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">same initial parameter settings as the interactive calculator. You can override these</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">defaults by using different arguments when initializing the :class:`EscapeCalculator`.</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">See https://github.com/jbloomlab/SARS2-RBD-escape-calc for all code and data. The</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">calculator is written by Jesse Bloom, and the citation is</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">`this paper &lt;https://doi.org/10.1093/ve/veac021&gt;`_.</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">To use the calculator, open a Python session, import this module, and initialize an</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">:class:`EscapeCalculator`:</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">&gt;&gt;&gt; calc = EscapeCalculator()</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">With no mutations, there is no escape (all neutralization retained):</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">&gt;&gt;&gt; assert calc.binding_retained([]) == 1.0</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">But if you mutate some key antigenic sites, there will be a dramatic reduction in</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">neutralization retained:</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">&gt;&gt;&gt; assert calc.binding_retained([440, 505]).round(3) == 0.545</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">If you have a whole set of sequences and have tabulated which sites are mutated,</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">you can apply the calculator in bulk to the data frame.</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">First, create such a data frame of sequences:</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">&gt;&gt;&gt; import pandas as pd</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">&gt;&gt;&gt; seqs = pd.DataFrame.from_records(</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">...     [(&quot;seq1&quot;, []), (&quot;seq2&quot;, [498]), (&quot;seq3&quot;, [440]), (&quot;seq4&quot;, [440, 505])],</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">...     columns=[&quot;name&quot;, &quot;mutated sites&quot;],</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">... )</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">&gt;&gt;&gt; seqs</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">   name mutated sites</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">0  seq1            []</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">1  seq2         [498]</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">2  seq3         [440]</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">3  seq4    [440, 505]</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">Now apply the calculator:</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">&gt;&gt;&gt; seqs[&quot;neutralization retained&quot;] = seqs[&quot;mutated sites&quot;].map(calc.binding_retained)</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">&gt;&gt;&gt; seqs.round(3)</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">   name mutated sites  neutralization retained</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">0  seq1            []                    1.000</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">1  seq2         [498]                    0.769</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">2  seq3         [440]                    0.790</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">3  seq4    [440, 505]                    0.545</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">You can also create new calculators that compute escape relative to different viruses,</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">for instance BA.2:</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">&gt;&gt;&gt; calc_ba2 = EscapeCalculator(virus=&quot;BA.2&quot;)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">Now the escape will be different because different antibodies neutralize that virus:</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">&gt;&gt;&gt; assert calc_ba2.binding_retained([440, 505]).round(3) == 0.786</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="n">__docformat__</span> <span class="o">=</span> <span class="s1">&#39;numpy&#39;</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="kn">import</span> <span class="nn">requests</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="kn">import</span> <span class="nn">numpy</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="kn">import</span> <span class="nn">yaml</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="k">class</span> <span class="nc">EscapeCalculator</span><span class="p">:</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates residual polyclonal antibody binding after some mutations.</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd">    The calculator is implemented interactively at</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd">    `https://jbloomlab.github.io/SARS2-RBD-escape-calc &lt;https://jbloomlab.github.io/SARS2-RBD-escape-calc/&gt;`_</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">    By default, this command-line calculator will exactly implement the calculations of the</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">    interactive calculator with default settings. You can pass parameters to override</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">    the default settings.</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">    Parameters</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">    ----------</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">    escape : str</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">        Path or URL of CSV containing the escape data.</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">    antibody_ic50s : str</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">        Path or URL of CSV containing the antibody IC50s.</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">    antibody_sources : str</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">        Path or URL of CSV containing the antibody sources.</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">    antibody_reweighting : str</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">        Path or URL of CSV containing the antibody reweightings.</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">    config : str</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">        Path or URL of YAML file containing initial settings.</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">    mut_escape_strength : None or float</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">        If not `None`, override default `init_mutation_escape_strength` in `config`.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">    weight_by_neg_log_ic50 : None or bool</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">        If not `None`, override default `init_weight_by_neg_log_IC50` in `config`.</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">    study : None or str</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">        If not `None`, override default `init_study` in `config`.</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">    virus : None or str</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">        If not `None`, override default `init_virus` in `config`.</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">    sources : None or dict</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="sd">        If not `None`, override default `init_sources` in `config`.</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">    reweight : None or bool</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">        If not `None`, override default `init_reweight` in `config`.</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="sd">    Example</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">    -------</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="sd">    Initialize the calculator:</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">    &gt;&gt;&gt; calc = EscapeCalculator()</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">    Calculate escape at sites after some mutations:</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="sd">    &gt;&gt;&gt; sites_of_interest = [403, 440, 484, 498, 505, 510]</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="sd">    &gt;&gt;&gt; calc.escape_per_site([440, 505]).query(&quot;site in @sites_of_interest&quot;).round(3)</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="sd">         site  original_escape  retained_escape</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">    69    403            0.105            0.030</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">    101   440            0.162            0.018</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">    143   484            0.043            0.032</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="sd">    156   498            0.169            0.076</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="sd">    163   505            0.208            0.022</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="sd">    167   510            0.001            0.001</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">    Calculate overall neutralization retained after no mutations or some mutations:</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="sd">    &gt;&gt;&gt; assert calc.binding_retained([]) == 1.0</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a><span class="sd">    &gt;&gt;&gt; assert calc.binding_retained([440, 505]).round(3) == 0.545</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">    Now repeat tests with some non-default options:</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">    &gt;&gt;&gt; calc2 = EscapeCalculator(</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">    ...     mut_escape_strength=1,</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">    ...     weight_by_neg_log_ic50=False,</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="sd">    ...     study=&quot;Cao et al, 2022, Nature&quot;,</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">    ...     virus=&quot;D614G&quot;,</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">    ...     sources={&quot;include_exclude&quot;: &quot;include&quot;, &quot;sources&quot;: [&quot;WT convalescents&quot;]},</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">    ... )</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a><span class="sd">    &gt;&gt;&gt; calc2.escape_per_site([484]).query(&quot;site in @sites_of_interest&quot;).round(3)</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a><span class="sd">         site  original_escape  retained_escape</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="sd">    62    403            0.006            0.006</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a><span class="sd">    84    440            0.008            0.007</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a><span class="sd">    123   484            0.212            0.029</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="sd">    134   498            0.009            0.008</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="sd">    141   505            0.002            0.002</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="sd">    144   510            0.000            0.000</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a><span class="sd">    &gt;&gt;&gt; assert calc2.binding_retained([484]).round(3) == 0.788</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>        <span class="n">escape</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/results/escape.csv&quot;</span><span class="p">,</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>        <span class="n">antibody_ic50s</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/results/antibody_IC50s.csv&quot;</span><span class="p">,</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="n">antibody_sources</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/results/antibody_sources.csv&quot;</span><span class="p">,</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>        <span class="n">antibody_reweighting</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/results/antibody_reweighting.csv&quot;</span><span class="p">,</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="n">config</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/config.yaml&quot;</span><span class="p">,</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="n">mut_escape_strength</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="n">weight_by_neg_log_ic50</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>        <span class="n">study</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="n">virus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>        <span class="n">sources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>        <span class="n">reweight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>    <span class="p">):</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;See main class docstring.&quot;&quot;&quot;</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>        <span class="c1"># read input data </span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">escape</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">escape</span><span class="p">)</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="s2">&quot;escape&quot;</span><span class="p">}</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">escape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="s2">&quot;escape&quot;</span><span class="p">]))</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>        <span class="n">antibodies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">escape</span><span class="p">[</span><span class="s2">&quot;antibody&quot;</span><span class="p">])</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">antibody_ic50s</span><span class="p">)</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;virus&quot;</span><span class="p">,</span> <span class="s2">&quot;IC50&quot;</span><span class="p">}</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="p">)</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>            <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;virus&quot;</span><span class="p">,</span> <span class="s2">&quot;IC50&quot;</span><span class="p">]))</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>        <span class="p">)</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="p">[</span><span class="s2">&quot;IC50&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">10</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>        <span class="k">assert</span> <span class="n">antibodies</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="p">[</span><span class="s2">&quot;antibody&quot;</span><span class="p">])</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">antibody_sources</span><span class="p">)</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;study&quot;</span><span class="p">}</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span><span class="p">)</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>            <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;study&quot;</span><span class="p">]))</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>            <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">antibodies</span><span class="p">)</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>        <span class="p">)</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="k">assert</span> <span class="n">antibodies</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span><span class="p">[</span><span class="s2">&quot;antibody&quot;</span><span class="p">])</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">antibody_reweighting</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">antibody_reweighting</span><span class="p">)</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_reweighting</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;reweight&quot;</span><span class="p">}</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>        <span class="k">assert</span> <span class="n">antibodies</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_reweighting</span><span class="p">[</span><span class="s2">&quot;antibody&quot;</span><span class="p">])</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">escape</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;antibody&quot;</span><span class="p">)</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;antibody&quot;</span><span class="p">)</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_reweighting</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">reweight</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;reweight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        <span class="p">)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>        <span class="c1"># get initial config</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>            <span class="n">config_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>                <span class="n">config_text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">config_text</span><span class="p">)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sites</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;sites&quot;</span><span class="p">][</span><span class="s2">&quot;start&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;sites&quot;</span><span class="p">][</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="n">studies</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;studies&quot;</span><span class="p">]</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>        <span class="n">studies_rev</span> <span class="o">=</span> <span class="p">{</span><span class="n">value</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">studies</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;study&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">studies</span><span class="p">)</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>        <span class="k">if</span> <span class="n">mut_escape_strength</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mut_escape_strength</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_mutation_escape_strength&quot;</span><span class="p">]</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mut_escape_strength</span> <span class="o">=</span> <span class="n">mut_escape_strength</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>        <span class="k">if</span> <span class="n">weight_by_neg_log_ic50</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_weight_by_neg_log_IC50&quot;</span><span class="p">]</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span> <span class="o">=</span> <span class="n">weight_by_neg_log_ic50</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>        <span class="k">if</span> <span class="n">study</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">study</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_study&quot;</span><span class="p">]</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>            <span class="k">if</span> <span class="n">study</span> <span class="o">==</span> <span class="s2">&quot;any&quot;</span> <span class="ow">or</span> <span class="n">study</span> <span class="ow">in</span> <span class="n">studies</span><span class="p">:</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">study</span> <span class="o">=</span> <span class="n">study</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>            <span class="k">elif</span> <span class="n">study</span> <span class="ow">in</span> <span class="n">studies_rev</span><span class="p">:</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">study</span> <span class="o">=</span> <span class="n">studies_rev</span><span class="p">[</span><span class="n">study</span><span class="p">]</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid </span><span class="si">{</span><span class="n">study</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="k">if</span> <span class="n">virus</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virus</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_virus&quot;</span><span class="p">]</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virus</span> <span class="o">=</span> <span class="n">virus</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>        <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>            <span class="n">sources</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_sources&quot;</span><span class="p">]</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="n">include_exclude</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;include_exclude&quot;</span><span class="p">]</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="n">sources_list</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;sources&quot;</span><span class="p">]</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">sources_list</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="si">=}</span><span class="se">\n</span><span class="si">{</span><span class="n">sources_list</span><span class="si">=}</span><span class="s2">&quot;</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>        <span class="k">if</span> <span class="n">include_exclude</span> <span class="o">==</span> <span class="s2">&quot;exclude&quot;</span><span class="p">:</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">sources_list</span><span class="p">)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>        <span class="k">elif</span> <span class="n">include_exclude</span> <span class="o">==</span> <span class="s2">&quot;include&quot;</span><span class="p">:</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sources_list</span><span class="p">)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid </span><span class="si">{</span><span class="n">include_exclude</span><span class="si">=}</span><span class="s2"> in </span><span class="si">{</span><span class="n">sources</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>        <span class="k">if</span> <span class="n">reweight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reweight</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_reweight&quot;</span><span class="p">]</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reweight</span> <span class="o">=</span> <span class="n">reweight</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reweight</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>        <span class="c1"># filter data</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">study</span> <span class="o">!=</span> <span class="s2">&quot;any&quot;</span><span class="p">:</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">study</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;study&quot;</span><span class="p">])</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;study == @self.study&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;study&quot;</span><span class="p">)</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;study&quot;</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">virus</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;virus&quot;</span><span class="p">])</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;virus == @self.virus&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;virus&quot;</span><span class="p">)</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;source in @self.sources&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;source&quot;</span><span class="p">)</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="s2">&quot;escape&quot;</span><span class="p">,</span> <span class="s2">&quot;IC50&quot;</span><span class="p">,</span> <span class="s2">&quot;reweight&quot;</span><span class="p">}</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">neg_log_ic50</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;IC50&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;IC50&quot;</span><span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>        <span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="n">max_escape_per_antibody</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;antibody&quot;</span><span class="p">)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>            <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">max_escape</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="s2">&quot;escape&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">))</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="p">)</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="k">assert</span> <span class="p">(</span><span class="n">max_escape_per_antibody</span><span class="p">[</span><span class="s2">&quot;max_escape&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>    <span class="k">def</span> <span class="nf">escape_per_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mutated_sites</span><span class="p">):</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Escape at each site after mutating indicated sites.</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a><span class="sd">        Parameters</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a><span class="sd">        ----------</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a><span class="sd">        mutated_sites : array-like of integers</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a><span class="sd">            List of mutated sites.</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a><span class="sd">        Returns</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a><span class="sd">        -------</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a><span class="sd">            For each site, gives the original escape and the escape</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a><span class="sd">            retained after mutations.</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>        <span class="n">mutated_sites</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mutated_sites</span><span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">mutated_sites</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">):</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sites </span><span class="si">{</span><span class="n">mutated_sites</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="si">}</span><span class="s2"> not in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>                <span class="n">mutated</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mutated_sites</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>                <span class="n">site_bind_retain</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;escape&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;mutated&quot;</span><span class="p">],</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>            <span class="p">)</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;neg_log_ic50&quot;</span><span class="p">,</span> <span class="s2">&quot;reweight&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>            <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">antibody_bind_retain</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="s2">&quot;site_bind_retain&quot;</span><span class="p">,</span> <span class="s2">&quot;prod&quot;</span><span class="p">))</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>                <span class="n">antibody_bind_retain</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;antibody_bind_retain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mut_escape_strength</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>                <span class="p">),</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>                <span class="n">weight</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>                    <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;neg_log_ic50&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>                    <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;reweight&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>                <span class="p">),</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>            <span class="p">)</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>            <span class="p">[[</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;antibody_bind_retain&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">]]</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="s2">&quot;escape&quot;</span><span class="p">]])</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>                <span class="n">escape</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;escape&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>                <span class="n">retained_escape</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;antibody_bind_retain&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;escape&quot;</span><span class="p">],</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>            <span class="p">)</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;site&quot;</span><span class="p">)</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>            <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>                <span class="n">original_escape</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="s2">&quot;escape&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">),</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>                <span class="n">retained_escape</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="s2">&quot;retained_escape&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">),</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>            <span class="p">)</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;antibody&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>    <span class="k">def</span> <span class="nf">binding_retained</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mutated_sites</span><span class="p">):</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fraction binding or neutralization retained after mutating indicated sites.</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a><span class="sd">        Parameters</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a><span class="sd">        ----------</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a><span class="sd">        mutated_sites : array-like of integers</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a><span class="sd">            List of mutated sites, must all be in :attr:`BindingCalculator.sites`.</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a><span class="sd">        Returns</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="sd">        -------</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a><span class="sd">        float</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a><span class="sd">            The fraction binding retained after these mutations.</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>        <span class="n">mutated_sites</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mutated_sites</span><span class="p">)</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">mutated_sites</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">):</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sites </span><span class="si">{</span><span class="n">mutated_sites</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="si">}</span><span class="s2"> not in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>        <span class="n">retained</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>                <span class="n">mutated</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mutated_sites</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>                <span class="n">site_bind_retain</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;escape&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;mutated&quot;</span><span class="p">],</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>            <span class="p">)</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;neg_log_ic50&quot;</span><span class="p">,</span> <span class="s2">&quot;reweight&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>            <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">antibody_bind_retain</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="s2">&quot;site_bind_retain&quot;</span><span class="p">,</span> <span class="s2">&quot;prod&quot;</span><span class="p">))</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>                <span class="n">antibody_bind_retain</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;antibody_bind_retain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mut_escape_strength</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>                <span class="p">),</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>                <span class="n">weight</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>                    <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;neg_log_ic50&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>                    <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;reweight&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>                <span class="p">),</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>                <span class="n">weighted_antibody_bind_retain</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>                    <span class="n">x</span><span class="p">[</span><span class="s2">&quot;antibody_bind_retain&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>                <span class="p">),</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>            <span class="p">)</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>            <span class="p">[[</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="s2">&quot;weighted_antibody_bind_retain&quot;</span><span class="p">]]</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>            <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="p">)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>        <span class="k">return</span> <span class="n">retained</span><span class="p">[</span><span class="s2">&quot;weighted_antibody_bind_retain&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">retained</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>    <span class="kn">import</span> <span class="nn">doctest</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</span></pre></div>


            </section>
                <section id="EscapeCalculator">
                            <input id="EscapeCalculator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">EscapeCalculator</span>:

                <label class="view-source-button" for="EscapeCalculator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EscapeCalculator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EscapeCalculator-82"><a href="#EscapeCalculator-82"><span class="linenos"> 82</span></a><span class="k">class</span> <span class="nc">EscapeCalculator</span><span class="p">:</span>
</span><span id="EscapeCalculator-83"><a href="#EscapeCalculator-83"><span class="linenos"> 83</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates residual polyclonal antibody binding after some mutations.</span>
</span><span id="EscapeCalculator-84"><a href="#EscapeCalculator-84"><span class="linenos"> 84</span></a>
</span><span id="EscapeCalculator-85"><a href="#EscapeCalculator-85"><span class="linenos"> 85</span></a><span class="sd">    The calculator is implemented interactively at</span>
</span><span id="EscapeCalculator-86"><a href="#EscapeCalculator-86"><span class="linenos"> 86</span></a><span class="sd">    `https://jbloomlab.github.io/SARS2-RBD-escape-calc &lt;https://jbloomlab.github.io/SARS2-RBD-escape-calc/&gt;`_</span>
</span><span id="EscapeCalculator-87"><a href="#EscapeCalculator-87"><span class="linenos"> 87</span></a>
</span><span id="EscapeCalculator-88"><a href="#EscapeCalculator-88"><span class="linenos"> 88</span></a><span class="sd">    By default, this command-line calculator will exactly implement the calculations of the</span>
</span><span id="EscapeCalculator-89"><a href="#EscapeCalculator-89"><span class="linenos"> 89</span></a><span class="sd">    interactive calculator with default settings. You can pass parameters to override</span>
</span><span id="EscapeCalculator-90"><a href="#EscapeCalculator-90"><span class="linenos"> 90</span></a><span class="sd">    the default settings.</span>
</span><span id="EscapeCalculator-91"><a href="#EscapeCalculator-91"><span class="linenos"> 91</span></a>
</span><span id="EscapeCalculator-92"><a href="#EscapeCalculator-92"><span class="linenos"> 92</span></a><span class="sd">    Parameters</span>
</span><span id="EscapeCalculator-93"><a href="#EscapeCalculator-93"><span class="linenos"> 93</span></a><span class="sd">    ----------</span>
</span><span id="EscapeCalculator-94"><a href="#EscapeCalculator-94"><span class="linenos"> 94</span></a><span class="sd">    escape : str</span>
</span><span id="EscapeCalculator-95"><a href="#EscapeCalculator-95"><span class="linenos"> 95</span></a><span class="sd">        Path or URL of CSV containing the escape data.</span>
</span><span id="EscapeCalculator-96"><a href="#EscapeCalculator-96"><span class="linenos"> 96</span></a><span class="sd">    antibody_ic50s : str</span>
</span><span id="EscapeCalculator-97"><a href="#EscapeCalculator-97"><span class="linenos"> 97</span></a><span class="sd">        Path or URL of CSV containing the antibody IC50s.</span>
</span><span id="EscapeCalculator-98"><a href="#EscapeCalculator-98"><span class="linenos"> 98</span></a><span class="sd">    antibody_sources : str</span>
</span><span id="EscapeCalculator-99"><a href="#EscapeCalculator-99"><span class="linenos"> 99</span></a><span class="sd">        Path or URL of CSV containing the antibody sources.</span>
</span><span id="EscapeCalculator-100"><a href="#EscapeCalculator-100"><span class="linenos">100</span></a><span class="sd">    antibody_reweighting : str</span>
</span><span id="EscapeCalculator-101"><a href="#EscapeCalculator-101"><span class="linenos">101</span></a><span class="sd">        Path or URL of CSV containing the antibody reweightings.</span>
</span><span id="EscapeCalculator-102"><a href="#EscapeCalculator-102"><span class="linenos">102</span></a><span class="sd">    config : str</span>
</span><span id="EscapeCalculator-103"><a href="#EscapeCalculator-103"><span class="linenos">103</span></a><span class="sd">        Path or URL of YAML file containing initial settings.</span>
</span><span id="EscapeCalculator-104"><a href="#EscapeCalculator-104"><span class="linenos">104</span></a><span class="sd">    mut_escape_strength : None or float</span>
</span><span id="EscapeCalculator-105"><a href="#EscapeCalculator-105"><span class="linenos">105</span></a><span class="sd">        If not `None`, override default `init_mutation_escape_strength` in `config`.</span>
</span><span id="EscapeCalculator-106"><a href="#EscapeCalculator-106"><span class="linenos">106</span></a><span class="sd">    weight_by_neg_log_ic50 : None or bool</span>
</span><span id="EscapeCalculator-107"><a href="#EscapeCalculator-107"><span class="linenos">107</span></a><span class="sd">        If not `None`, override default `init_weight_by_neg_log_IC50` in `config`.</span>
</span><span id="EscapeCalculator-108"><a href="#EscapeCalculator-108"><span class="linenos">108</span></a><span class="sd">    study : None or str</span>
</span><span id="EscapeCalculator-109"><a href="#EscapeCalculator-109"><span class="linenos">109</span></a><span class="sd">        If not `None`, override default `init_study` in `config`.</span>
</span><span id="EscapeCalculator-110"><a href="#EscapeCalculator-110"><span class="linenos">110</span></a><span class="sd">    virus : None or str</span>
</span><span id="EscapeCalculator-111"><a href="#EscapeCalculator-111"><span class="linenos">111</span></a><span class="sd">        If not `None`, override default `init_virus` in `config`.</span>
</span><span id="EscapeCalculator-112"><a href="#EscapeCalculator-112"><span class="linenos">112</span></a><span class="sd">    sources : None or dict</span>
</span><span id="EscapeCalculator-113"><a href="#EscapeCalculator-113"><span class="linenos">113</span></a><span class="sd">        If not `None`, override default `init_sources` in `config`.</span>
</span><span id="EscapeCalculator-114"><a href="#EscapeCalculator-114"><span class="linenos">114</span></a><span class="sd">    reweight : None or bool</span>
</span><span id="EscapeCalculator-115"><a href="#EscapeCalculator-115"><span class="linenos">115</span></a><span class="sd">        If not `None`, override default `init_reweight` in `config`.</span>
</span><span id="EscapeCalculator-116"><a href="#EscapeCalculator-116"><span class="linenos">116</span></a>
</span><span id="EscapeCalculator-117"><a href="#EscapeCalculator-117"><span class="linenos">117</span></a><span class="sd">    Example</span>
</span><span id="EscapeCalculator-118"><a href="#EscapeCalculator-118"><span class="linenos">118</span></a><span class="sd">    -------</span>
</span><span id="EscapeCalculator-119"><a href="#EscapeCalculator-119"><span class="linenos">119</span></a>
</span><span id="EscapeCalculator-120"><a href="#EscapeCalculator-120"><span class="linenos">120</span></a><span class="sd">    Initialize the calculator:</span>
</span><span id="EscapeCalculator-121"><a href="#EscapeCalculator-121"><span class="linenos">121</span></a>
</span><span id="EscapeCalculator-122"><a href="#EscapeCalculator-122"><span class="linenos">122</span></a><span class="sd">    &gt;&gt;&gt; calc = EscapeCalculator()</span>
</span><span id="EscapeCalculator-123"><a href="#EscapeCalculator-123"><span class="linenos">123</span></a>
</span><span id="EscapeCalculator-124"><a href="#EscapeCalculator-124"><span class="linenos">124</span></a><span class="sd">    Calculate escape at sites after some mutations:</span>
</span><span id="EscapeCalculator-125"><a href="#EscapeCalculator-125"><span class="linenos">125</span></a>
</span><span id="EscapeCalculator-126"><a href="#EscapeCalculator-126"><span class="linenos">126</span></a><span class="sd">    &gt;&gt;&gt; sites_of_interest = [403, 440, 484, 498, 505, 510]</span>
</span><span id="EscapeCalculator-127"><a href="#EscapeCalculator-127"><span class="linenos">127</span></a><span class="sd">    &gt;&gt;&gt; calc.escape_per_site([440, 505]).query(&quot;site in @sites_of_interest&quot;).round(3)</span>
</span><span id="EscapeCalculator-128"><a href="#EscapeCalculator-128"><span class="linenos">128</span></a><span class="sd">         site  original_escape  retained_escape</span>
</span><span id="EscapeCalculator-129"><a href="#EscapeCalculator-129"><span class="linenos">129</span></a><span class="sd">    69    403            0.105            0.030</span>
</span><span id="EscapeCalculator-130"><a href="#EscapeCalculator-130"><span class="linenos">130</span></a><span class="sd">    101   440            0.162            0.018</span>
</span><span id="EscapeCalculator-131"><a href="#EscapeCalculator-131"><span class="linenos">131</span></a><span class="sd">    143   484            0.043            0.032</span>
</span><span id="EscapeCalculator-132"><a href="#EscapeCalculator-132"><span class="linenos">132</span></a><span class="sd">    156   498            0.169            0.076</span>
</span><span id="EscapeCalculator-133"><a href="#EscapeCalculator-133"><span class="linenos">133</span></a><span class="sd">    163   505            0.208            0.022</span>
</span><span id="EscapeCalculator-134"><a href="#EscapeCalculator-134"><span class="linenos">134</span></a><span class="sd">    167   510            0.001            0.001</span>
</span><span id="EscapeCalculator-135"><a href="#EscapeCalculator-135"><span class="linenos">135</span></a>
</span><span id="EscapeCalculator-136"><a href="#EscapeCalculator-136"><span class="linenos">136</span></a><span class="sd">    Calculate overall neutralization retained after no mutations or some mutations:</span>
</span><span id="EscapeCalculator-137"><a href="#EscapeCalculator-137"><span class="linenos">137</span></a>
</span><span id="EscapeCalculator-138"><a href="#EscapeCalculator-138"><span class="linenos">138</span></a><span class="sd">    &gt;&gt;&gt; assert calc.binding_retained([]) == 1.0</span>
</span><span id="EscapeCalculator-139"><a href="#EscapeCalculator-139"><span class="linenos">139</span></a><span class="sd">    &gt;&gt;&gt; assert calc.binding_retained([440, 505]).round(3) == 0.545</span>
</span><span id="EscapeCalculator-140"><a href="#EscapeCalculator-140"><span class="linenos">140</span></a>
</span><span id="EscapeCalculator-141"><a href="#EscapeCalculator-141"><span class="linenos">141</span></a><span class="sd">    Now repeat tests with some non-default options:</span>
</span><span id="EscapeCalculator-142"><a href="#EscapeCalculator-142"><span class="linenos">142</span></a>
</span><span id="EscapeCalculator-143"><a href="#EscapeCalculator-143"><span class="linenos">143</span></a><span class="sd">    &gt;&gt;&gt; calc2 = EscapeCalculator(</span>
</span><span id="EscapeCalculator-144"><a href="#EscapeCalculator-144"><span class="linenos">144</span></a><span class="sd">    ...     mut_escape_strength=1,</span>
</span><span id="EscapeCalculator-145"><a href="#EscapeCalculator-145"><span class="linenos">145</span></a><span class="sd">    ...     weight_by_neg_log_ic50=False,</span>
</span><span id="EscapeCalculator-146"><a href="#EscapeCalculator-146"><span class="linenos">146</span></a><span class="sd">    ...     study=&quot;Cao et al, 2022, Nature&quot;,</span>
</span><span id="EscapeCalculator-147"><a href="#EscapeCalculator-147"><span class="linenos">147</span></a><span class="sd">    ...     virus=&quot;D614G&quot;,</span>
</span><span id="EscapeCalculator-148"><a href="#EscapeCalculator-148"><span class="linenos">148</span></a><span class="sd">    ...     sources={&quot;include_exclude&quot;: &quot;include&quot;, &quot;sources&quot;: [&quot;WT convalescents&quot;]},</span>
</span><span id="EscapeCalculator-149"><a href="#EscapeCalculator-149"><span class="linenos">149</span></a><span class="sd">    ... )</span>
</span><span id="EscapeCalculator-150"><a href="#EscapeCalculator-150"><span class="linenos">150</span></a>
</span><span id="EscapeCalculator-151"><a href="#EscapeCalculator-151"><span class="linenos">151</span></a><span class="sd">    &gt;&gt;&gt; calc2.escape_per_site([484]).query(&quot;site in @sites_of_interest&quot;).round(3)</span>
</span><span id="EscapeCalculator-152"><a href="#EscapeCalculator-152"><span class="linenos">152</span></a><span class="sd">         site  original_escape  retained_escape</span>
</span><span id="EscapeCalculator-153"><a href="#EscapeCalculator-153"><span class="linenos">153</span></a><span class="sd">    62    403            0.006            0.006</span>
</span><span id="EscapeCalculator-154"><a href="#EscapeCalculator-154"><span class="linenos">154</span></a><span class="sd">    84    440            0.008            0.007</span>
</span><span id="EscapeCalculator-155"><a href="#EscapeCalculator-155"><span class="linenos">155</span></a><span class="sd">    123   484            0.212            0.029</span>
</span><span id="EscapeCalculator-156"><a href="#EscapeCalculator-156"><span class="linenos">156</span></a><span class="sd">    134   498            0.009            0.008</span>
</span><span id="EscapeCalculator-157"><a href="#EscapeCalculator-157"><span class="linenos">157</span></a><span class="sd">    141   505            0.002            0.002</span>
</span><span id="EscapeCalculator-158"><a href="#EscapeCalculator-158"><span class="linenos">158</span></a><span class="sd">    144   510            0.000            0.000</span>
</span><span id="EscapeCalculator-159"><a href="#EscapeCalculator-159"><span class="linenos">159</span></a>
</span><span id="EscapeCalculator-160"><a href="#EscapeCalculator-160"><span class="linenos">160</span></a><span class="sd">    &gt;&gt;&gt; assert calc2.binding_retained([484]).round(3) == 0.788</span>
</span><span id="EscapeCalculator-161"><a href="#EscapeCalculator-161"><span class="linenos">161</span></a>
</span><span id="EscapeCalculator-162"><a href="#EscapeCalculator-162"><span class="linenos">162</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="EscapeCalculator-163"><a href="#EscapeCalculator-163"><span class="linenos">163</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="EscapeCalculator-164"><a href="#EscapeCalculator-164"><span class="linenos">164</span></a>        <span class="n">escape</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/results/escape.csv&quot;</span><span class="p">,</span>
</span><span id="EscapeCalculator-165"><a href="#EscapeCalculator-165"><span class="linenos">165</span></a>        <span class="n">antibody_ic50s</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/results/antibody_IC50s.csv&quot;</span><span class="p">,</span>
</span><span id="EscapeCalculator-166"><a href="#EscapeCalculator-166"><span class="linenos">166</span></a>        <span class="n">antibody_sources</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/results/antibody_sources.csv&quot;</span><span class="p">,</span>
</span><span id="EscapeCalculator-167"><a href="#EscapeCalculator-167"><span class="linenos">167</span></a>        <span class="n">antibody_reweighting</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/results/antibody_reweighting.csv&quot;</span><span class="p">,</span>
</span><span id="EscapeCalculator-168"><a href="#EscapeCalculator-168"><span class="linenos">168</span></a>        <span class="n">config</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/config.yaml&quot;</span><span class="p">,</span>
</span><span id="EscapeCalculator-169"><a href="#EscapeCalculator-169"><span class="linenos">169</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="EscapeCalculator-170"><a href="#EscapeCalculator-170"><span class="linenos">170</span></a>        <span class="n">mut_escape_strength</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="EscapeCalculator-171"><a href="#EscapeCalculator-171"><span class="linenos">171</span></a>        <span class="n">weight_by_neg_log_ic50</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="EscapeCalculator-172"><a href="#EscapeCalculator-172"><span class="linenos">172</span></a>        <span class="n">study</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="EscapeCalculator-173"><a href="#EscapeCalculator-173"><span class="linenos">173</span></a>        <span class="n">virus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="EscapeCalculator-174"><a href="#EscapeCalculator-174"><span class="linenos">174</span></a>        <span class="n">sources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="EscapeCalculator-175"><a href="#EscapeCalculator-175"><span class="linenos">175</span></a>        <span class="n">reweight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="EscapeCalculator-176"><a href="#EscapeCalculator-176"><span class="linenos">176</span></a>    <span class="p">):</span>
</span><span id="EscapeCalculator-177"><a href="#EscapeCalculator-177"><span class="linenos">177</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;See main class docstring.&quot;&quot;&quot;</span>
</span><span id="EscapeCalculator-178"><a href="#EscapeCalculator-178"><span class="linenos">178</span></a>        <span class="c1"># read input data </span>
</span><span id="EscapeCalculator-179"><a href="#EscapeCalculator-179"><span class="linenos">179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">escape</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">escape</span><span class="p">)</span>
</span><span id="EscapeCalculator-180"><a href="#EscapeCalculator-180"><span class="linenos">180</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="s2">&quot;escape&quot;</span><span class="p">}</span>
</span><span id="EscapeCalculator-181"><a href="#EscapeCalculator-181"><span class="linenos">181</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">escape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="s2">&quot;escape&quot;</span><span class="p">]))</span>
</span><span id="EscapeCalculator-182"><a href="#EscapeCalculator-182"><span class="linenos">182</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="EscapeCalculator-183"><a href="#EscapeCalculator-183"><span class="linenos">183</span></a>        <span class="n">antibodies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">escape</span><span class="p">[</span><span class="s2">&quot;antibody&quot;</span><span class="p">])</span>
</span><span id="EscapeCalculator-184"><a href="#EscapeCalculator-184"><span class="linenos">184</span></a>
</span><span id="EscapeCalculator-185"><a href="#EscapeCalculator-185"><span class="linenos">185</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">antibody_ic50s</span><span class="p">)</span>
</span><span id="EscapeCalculator-186"><a href="#EscapeCalculator-186"><span class="linenos">186</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;virus&quot;</span><span class="p">,</span> <span class="s2">&quot;IC50&quot;</span><span class="p">}</span>
</span><span id="EscapeCalculator-187"><a href="#EscapeCalculator-187"><span class="linenos">187</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="EscapeCalculator-188"><a href="#EscapeCalculator-188"><span class="linenos">188</span></a>            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="p">)</span>
</span><span id="EscapeCalculator-189"><a href="#EscapeCalculator-189"><span class="linenos">189</span></a>            <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;virus&quot;</span><span class="p">,</span> <span class="s2">&quot;IC50&quot;</span><span class="p">]))</span>
</span><span id="EscapeCalculator-190"><a href="#EscapeCalculator-190"><span class="linenos">190</span></a>        <span class="p">)</span>
</span><span id="EscapeCalculator-191"><a href="#EscapeCalculator-191"><span class="linenos">191</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="p">[</span><span class="s2">&quot;IC50&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">10</span>
</span><span id="EscapeCalculator-192"><a href="#EscapeCalculator-192"><span class="linenos">192</span></a>        <span class="k">assert</span> <span class="n">antibodies</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="p">[</span><span class="s2">&quot;antibody&quot;</span><span class="p">])</span>
</span><span id="EscapeCalculator-193"><a href="#EscapeCalculator-193"><span class="linenos">193</span></a>
</span><span id="EscapeCalculator-194"><a href="#EscapeCalculator-194"><span class="linenos">194</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">antibody_sources</span><span class="p">)</span>
</span><span id="EscapeCalculator-195"><a href="#EscapeCalculator-195"><span class="linenos">195</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;study&quot;</span><span class="p">}</span>
</span><span id="EscapeCalculator-196"><a href="#EscapeCalculator-196"><span class="linenos">196</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="EscapeCalculator-197"><a href="#EscapeCalculator-197"><span class="linenos">197</span></a>            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span><span class="p">)</span>
</span><span id="EscapeCalculator-198"><a href="#EscapeCalculator-198"><span class="linenos">198</span></a>            <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;study&quot;</span><span class="p">]))</span>
</span><span id="EscapeCalculator-199"><a href="#EscapeCalculator-199"><span class="linenos">199</span></a>            <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">antibodies</span><span class="p">)</span>
</span><span id="EscapeCalculator-200"><a href="#EscapeCalculator-200"><span class="linenos">200</span></a>        <span class="p">)</span>
</span><span id="EscapeCalculator-201"><a href="#EscapeCalculator-201"><span class="linenos">201</span></a>        <span class="k">assert</span> <span class="n">antibodies</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span><span class="p">[</span><span class="s2">&quot;antibody&quot;</span><span class="p">])</span>
</span><span id="EscapeCalculator-202"><a href="#EscapeCalculator-202"><span class="linenos">202</span></a>
</span><span id="EscapeCalculator-203"><a href="#EscapeCalculator-203"><span class="linenos">203</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">antibody_reweighting</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">antibody_reweighting</span><span class="p">)</span>
</span><span id="EscapeCalculator-204"><a href="#EscapeCalculator-204"><span class="linenos">204</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_reweighting</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;reweight&quot;</span><span class="p">}</span>
</span><span id="EscapeCalculator-205"><a href="#EscapeCalculator-205"><span class="linenos">205</span></a>        <span class="k">assert</span> <span class="n">antibodies</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_reweighting</span><span class="p">[</span><span class="s2">&quot;antibody&quot;</span><span class="p">])</span>
</span><span id="EscapeCalculator-206"><a href="#EscapeCalculator-206"><span class="linenos">206</span></a>
</span><span id="EscapeCalculator-207"><a href="#EscapeCalculator-207"><span class="linenos">207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EscapeCalculator-208"><a href="#EscapeCalculator-208"><span class="linenos">208</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">escape</span>
</span><span id="EscapeCalculator-209"><a href="#EscapeCalculator-209"><span class="linenos">209</span></a>            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;antibody&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator-210"><a href="#EscapeCalculator-210"><span class="linenos">210</span></a>            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;antibody&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator-211"><a href="#EscapeCalculator-211"><span class="linenos">211</span></a>            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_reweighting</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator-212"><a href="#EscapeCalculator-212"><span class="linenos">212</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">reweight</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;reweight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="EscapeCalculator-213"><a href="#EscapeCalculator-213"><span class="linenos">213</span></a>        <span class="p">)</span>
</span><span id="EscapeCalculator-214"><a href="#EscapeCalculator-214"><span class="linenos">214</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="EscapeCalculator-215"><a href="#EscapeCalculator-215"><span class="linenos">215</span></a>
</span><span id="EscapeCalculator-216"><a href="#EscapeCalculator-216"><span class="linenos">216</span></a>        <span class="c1"># get initial config</span>
</span><span id="EscapeCalculator-217"><a href="#EscapeCalculator-217"><span class="linenos">217</span></a>        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
</span><span id="EscapeCalculator-218"><a href="#EscapeCalculator-218"><span class="linenos">218</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EscapeCalculator-219"><a href="#EscapeCalculator-219"><span class="linenos">219</span></a>            <span class="n">config_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator-220"><a href="#EscapeCalculator-220"><span class="linenos">220</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator-221"><a href="#EscapeCalculator-221"><span class="linenos">221</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="EscapeCalculator-222"><a href="#EscapeCalculator-222"><span class="linenos">222</span></a>                <span class="n">config_text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="EscapeCalculator-223"><a href="#EscapeCalculator-223"><span class="linenos">223</span></a>        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">config_text</span><span class="p">)</span>
</span><span id="EscapeCalculator-224"><a href="#EscapeCalculator-224"><span class="linenos">224</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sites</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;sites&quot;</span><span class="p">][</span><span class="s2">&quot;start&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;sites&quot;</span><span class="p">][</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="EscapeCalculator-225"><a href="#EscapeCalculator-225"><span class="linenos">225</span></a>        <span class="n">studies</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;studies&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator-226"><a href="#EscapeCalculator-226"><span class="linenos">226</span></a>        <span class="n">studies_rev</span> <span class="o">=</span> <span class="p">{</span><span class="n">value</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">studies</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="EscapeCalculator-227"><a href="#EscapeCalculator-227"><span class="linenos">227</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;study&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">studies</span><span class="p">)</span>
</span><span id="EscapeCalculator-228"><a href="#EscapeCalculator-228"><span class="linenos">228</span></a>
</span><span id="EscapeCalculator-229"><a href="#EscapeCalculator-229"><span class="linenos">229</span></a>        <span class="k">if</span> <span class="n">mut_escape_strength</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EscapeCalculator-230"><a href="#EscapeCalculator-230"><span class="linenos">230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mut_escape_strength</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_mutation_escape_strength&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator-231"><a href="#EscapeCalculator-231"><span class="linenos">231</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator-232"><a href="#EscapeCalculator-232"><span class="linenos">232</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mut_escape_strength</span> <span class="o">=</span> <span class="n">mut_escape_strength</span>
</span><span id="EscapeCalculator-233"><a href="#EscapeCalculator-233"><span class="linenos">233</span></a>
</span><span id="EscapeCalculator-234"><a href="#EscapeCalculator-234"><span class="linenos">234</span></a>        <span class="k">if</span> <span class="n">weight_by_neg_log_ic50</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EscapeCalculator-235"><a href="#EscapeCalculator-235"><span class="linenos">235</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_weight_by_neg_log_IC50&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator-236"><a href="#EscapeCalculator-236"><span class="linenos">236</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator-237"><a href="#EscapeCalculator-237"><span class="linenos">237</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span> <span class="o">=</span> <span class="n">weight_by_neg_log_ic50</span>
</span><span id="EscapeCalculator-238"><a href="#EscapeCalculator-238"><span class="linenos">238</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span>
</span><span id="EscapeCalculator-239"><a href="#EscapeCalculator-239"><span class="linenos">239</span></a>
</span><span id="EscapeCalculator-240"><a href="#EscapeCalculator-240"><span class="linenos">240</span></a>        <span class="k">if</span> <span class="n">study</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EscapeCalculator-241"><a href="#EscapeCalculator-241"><span class="linenos">241</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">study</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_study&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator-242"><a href="#EscapeCalculator-242"><span class="linenos">242</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator-243"><a href="#EscapeCalculator-243"><span class="linenos">243</span></a>            <span class="k">if</span> <span class="n">study</span> <span class="o">==</span> <span class="s2">&quot;any&quot;</span> <span class="ow">or</span> <span class="n">study</span> <span class="ow">in</span> <span class="n">studies</span><span class="p">:</span>
</span><span id="EscapeCalculator-244"><a href="#EscapeCalculator-244"><span class="linenos">244</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">study</span> <span class="o">=</span> <span class="n">study</span>
</span><span id="EscapeCalculator-245"><a href="#EscapeCalculator-245"><span class="linenos">245</span></a>            <span class="k">elif</span> <span class="n">study</span> <span class="ow">in</span> <span class="n">studies_rev</span><span class="p">:</span>
</span><span id="EscapeCalculator-246"><a href="#EscapeCalculator-246"><span class="linenos">246</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">study</span> <span class="o">=</span> <span class="n">studies_rev</span><span class="p">[</span><span class="n">study</span><span class="p">]</span>
</span><span id="EscapeCalculator-247"><a href="#EscapeCalculator-247"><span class="linenos">247</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator-248"><a href="#EscapeCalculator-248"><span class="linenos">248</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid </span><span class="si">{</span><span class="n">study</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator-249"><a href="#EscapeCalculator-249"><span class="linenos">249</span></a>
</span><span id="EscapeCalculator-250"><a href="#EscapeCalculator-250"><span class="linenos">250</span></a>        <span class="k">if</span> <span class="n">virus</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EscapeCalculator-251"><a href="#EscapeCalculator-251"><span class="linenos">251</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virus</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_virus&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator-252"><a href="#EscapeCalculator-252"><span class="linenos">252</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator-253"><a href="#EscapeCalculator-253"><span class="linenos">253</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virus</span> <span class="o">=</span> <span class="n">virus</span>
</span><span id="EscapeCalculator-254"><a href="#EscapeCalculator-254"><span class="linenos">254</span></a>
</span><span id="EscapeCalculator-255"><a href="#EscapeCalculator-255"><span class="linenos">255</span></a>        <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EscapeCalculator-256"><a href="#EscapeCalculator-256"><span class="linenos">256</span></a>            <span class="n">sources</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_sources&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator-257"><a href="#EscapeCalculator-257"><span class="linenos">257</span></a>        <span class="n">include_exclude</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;include_exclude&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator-258"><a href="#EscapeCalculator-258"><span class="linenos">258</span></a>        <span class="n">sources_list</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;sources&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator-259"><a href="#EscapeCalculator-259"><span class="linenos">259</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])</span>
</span><span id="EscapeCalculator-260"><a href="#EscapeCalculator-260"><span class="linenos">260</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">sources_list</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="si">=}</span><span class="se">\n</span><span class="si">{</span><span class="n">sources_list</span><span class="si">=}</span><span class="s2">&quot;</span>
</span><span id="EscapeCalculator-261"><a href="#EscapeCalculator-261"><span class="linenos">261</span></a>        <span class="k">if</span> <span class="n">include_exclude</span> <span class="o">==</span> <span class="s2">&quot;exclude&quot;</span><span class="p">:</span>
</span><span id="EscapeCalculator-262"><a href="#EscapeCalculator-262"><span class="linenos">262</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">sources_list</span><span class="p">)</span>
</span><span id="EscapeCalculator-263"><a href="#EscapeCalculator-263"><span class="linenos">263</span></a>        <span class="k">elif</span> <span class="n">include_exclude</span> <span class="o">==</span> <span class="s2">&quot;include&quot;</span><span class="p">:</span>
</span><span id="EscapeCalculator-264"><a href="#EscapeCalculator-264"><span class="linenos">264</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sources_list</span><span class="p">)</span>
</span><span id="EscapeCalculator-265"><a href="#EscapeCalculator-265"><span class="linenos">265</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator-266"><a href="#EscapeCalculator-266"><span class="linenos">266</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid </span><span class="si">{</span><span class="n">include_exclude</span><span class="si">=}</span><span class="s2"> in </span><span class="si">{</span><span class="n">sources</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator-267"><a href="#EscapeCalculator-267"><span class="linenos">267</span></a>
</span><span id="EscapeCalculator-268"><a href="#EscapeCalculator-268"><span class="linenos">268</span></a>        <span class="k">if</span> <span class="n">reweight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EscapeCalculator-269"><a href="#EscapeCalculator-269"><span class="linenos">269</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reweight</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_reweight&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator-270"><a href="#EscapeCalculator-270"><span class="linenos">270</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator-271"><a href="#EscapeCalculator-271"><span class="linenos">271</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reweight</span> <span class="o">=</span> <span class="n">reweight</span>
</span><span id="EscapeCalculator-272"><a href="#EscapeCalculator-272"><span class="linenos">272</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reweight</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight</span>
</span><span id="EscapeCalculator-273"><a href="#EscapeCalculator-273"><span class="linenos">273</span></a>
</span><span id="EscapeCalculator-274"><a href="#EscapeCalculator-274"><span class="linenos">274</span></a>        <span class="c1"># filter data</span>
</span><span id="EscapeCalculator-275"><a href="#EscapeCalculator-275"><span class="linenos">275</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">study</span> <span class="o">!=</span> <span class="s2">&quot;any&quot;</span><span class="p">:</span>
</span><span id="EscapeCalculator-276"><a href="#EscapeCalculator-276"><span class="linenos">276</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">study</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;study&quot;</span><span class="p">])</span>
</span><span id="EscapeCalculator-277"><a href="#EscapeCalculator-277"><span class="linenos">277</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;study == @self.study&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;study&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator-278"><a href="#EscapeCalculator-278"><span class="linenos">278</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator-279"><a href="#EscapeCalculator-279"><span class="linenos">279</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;study&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator-280"><a href="#EscapeCalculator-280"><span class="linenos">280</span></a>
</span><span id="EscapeCalculator-281"><a href="#EscapeCalculator-281"><span class="linenos">281</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">virus</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;virus&quot;</span><span class="p">])</span>
</span><span id="EscapeCalculator-282"><a href="#EscapeCalculator-282"><span class="linenos">282</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;virus == @self.virus&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;virus&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator-283"><a href="#EscapeCalculator-283"><span class="linenos">283</span></a>
</span><span id="EscapeCalculator-284"><a href="#EscapeCalculator-284"><span class="linenos">284</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;source in @self.sources&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;source&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator-285"><a href="#EscapeCalculator-285"><span class="linenos">285</span></a>
</span><span id="EscapeCalculator-286"><a href="#EscapeCalculator-286"><span class="linenos">286</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="s2">&quot;escape&quot;</span><span class="p">,</span> <span class="s2">&quot;IC50&quot;</span><span class="p">,</span> <span class="s2">&quot;reweight&quot;</span><span class="p">}</span>
</span><span id="EscapeCalculator-287"><a href="#EscapeCalculator-287"><span class="linenos">287</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>
</span><span id="EscapeCalculator-288"><a href="#EscapeCalculator-288"><span class="linenos">288</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EscapeCalculator-289"><a href="#EscapeCalculator-289"><span class="linenos">289</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="EscapeCalculator-290"><a href="#EscapeCalculator-290"><span class="linenos">290</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">neg_log_ic50</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;IC50&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>
</span><span id="EscapeCalculator-291"><a href="#EscapeCalculator-291"><span class="linenos">291</span></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;IC50&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator-292"><a href="#EscapeCalculator-292"><span class="linenos">292</span></a>        <span class="p">)</span>
</span><span id="EscapeCalculator-293"><a href="#EscapeCalculator-293"><span class="linenos">293</span></a>
</span><span id="EscapeCalculator-294"><a href="#EscapeCalculator-294"><span class="linenos">294</span></a>        <span class="n">max_escape_per_antibody</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EscapeCalculator-295"><a href="#EscapeCalculator-295"><span class="linenos">295</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="EscapeCalculator-296"><a href="#EscapeCalculator-296"><span class="linenos">296</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;antibody&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator-297"><a href="#EscapeCalculator-297"><span class="linenos">297</span></a>            <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">max_escape</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="s2">&quot;escape&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">))</span>
</span><span id="EscapeCalculator-298"><a href="#EscapeCalculator-298"><span class="linenos">298</span></a>        <span class="p">)</span>
</span><span id="EscapeCalculator-299"><a href="#EscapeCalculator-299"><span class="linenos">299</span></a>        <span class="k">assert</span> <span class="p">(</span><span class="n">max_escape_per_antibody</span><span class="p">[</span><span class="s2">&quot;max_escape&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="EscapeCalculator-300"><a href="#EscapeCalculator-300"><span class="linenos">300</span></a>
</span><span id="EscapeCalculator-301"><a href="#EscapeCalculator-301"><span class="linenos">301</span></a>    <span class="k">def</span> <span class="nf">escape_per_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mutated_sites</span><span class="p">):</span>
</span><span id="EscapeCalculator-302"><a href="#EscapeCalculator-302"><span class="linenos">302</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Escape at each site after mutating indicated sites.</span>
</span><span id="EscapeCalculator-303"><a href="#EscapeCalculator-303"><span class="linenos">303</span></a>
</span><span id="EscapeCalculator-304"><a href="#EscapeCalculator-304"><span class="linenos">304</span></a><span class="sd">        Parameters</span>
</span><span id="EscapeCalculator-305"><a href="#EscapeCalculator-305"><span class="linenos">305</span></a><span class="sd">        ----------</span>
</span><span id="EscapeCalculator-306"><a href="#EscapeCalculator-306"><span class="linenos">306</span></a><span class="sd">        mutated_sites : array-like of integers</span>
</span><span id="EscapeCalculator-307"><a href="#EscapeCalculator-307"><span class="linenos">307</span></a><span class="sd">            List of mutated sites.</span>
</span><span id="EscapeCalculator-308"><a href="#EscapeCalculator-308"><span class="linenos">308</span></a>
</span><span id="EscapeCalculator-309"><a href="#EscapeCalculator-309"><span class="linenos">309</span></a><span class="sd">        Returns</span>
</span><span id="EscapeCalculator-310"><a href="#EscapeCalculator-310"><span class="linenos">310</span></a><span class="sd">        -------</span>
</span><span id="EscapeCalculator-311"><a href="#EscapeCalculator-311"><span class="linenos">311</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="EscapeCalculator-312"><a href="#EscapeCalculator-312"><span class="linenos">312</span></a><span class="sd">            For each site, gives the original escape and the escape</span>
</span><span id="EscapeCalculator-313"><a href="#EscapeCalculator-313"><span class="linenos">313</span></a><span class="sd">            retained after mutations.</span>
</span><span id="EscapeCalculator-314"><a href="#EscapeCalculator-314"><span class="linenos">314</span></a>
</span><span id="EscapeCalculator-315"><a href="#EscapeCalculator-315"><span class="linenos">315</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EscapeCalculator-316"><a href="#EscapeCalculator-316"><span class="linenos">316</span></a>        <span class="n">mutated_sites</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mutated_sites</span><span class="p">)</span>
</span><span id="EscapeCalculator-317"><a href="#EscapeCalculator-317"><span class="linenos">317</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">mutated_sites</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">):</span>
</span><span id="EscapeCalculator-318"><a href="#EscapeCalculator-318"><span class="linenos">318</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sites </span><span class="si">{</span><span class="n">mutated_sites</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="si">}</span><span class="s2"> not in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator-319"><a href="#EscapeCalculator-319"><span class="linenos">319</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EscapeCalculator-320"><a href="#EscapeCalculator-320"><span class="linenos">320</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="EscapeCalculator-321"><a href="#EscapeCalculator-321"><span class="linenos">321</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="EscapeCalculator-322"><a href="#EscapeCalculator-322"><span class="linenos">322</span></a>                <span class="n">mutated</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mutated_sites</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
</span><span id="EscapeCalculator-323"><a href="#EscapeCalculator-323"><span class="linenos">323</span></a>                <span class="n">site_bind_retain</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;escape&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;mutated&quot;</span><span class="p">],</span>
</span><span id="EscapeCalculator-324"><a href="#EscapeCalculator-324"><span class="linenos">324</span></a>            <span class="p">)</span>
</span><span id="EscapeCalculator-325"><a href="#EscapeCalculator-325"><span class="linenos">325</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;neg_log_ic50&quot;</span><span class="p">,</span> <span class="s2">&quot;reweight&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EscapeCalculator-326"><a href="#EscapeCalculator-326"><span class="linenos">326</span></a>            <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">antibody_bind_retain</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="s2">&quot;site_bind_retain&quot;</span><span class="p">,</span> <span class="s2">&quot;prod&quot;</span><span class="p">))</span>
</span><span id="EscapeCalculator-327"><a href="#EscapeCalculator-327"><span class="linenos">327</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="EscapeCalculator-328"><a href="#EscapeCalculator-328"><span class="linenos">328</span></a>                <span class="n">antibody_bind_retain</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;antibody_bind_retain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span>
</span><span id="EscapeCalculator-329"><a href="#EscapeCalculator-329"><span class="linenos">329</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mut_escape_strength</span>
</span><span id="EscapeCalculator-330"><a href="#EscapeCalculator-330"><span class="linenos">330</span></a>                <span class="p">),</span>
</span><span id="EscapeCalculator-331"><a href="#EscapeCalculator-331"><span class="linenos">331</span></a>                <span class="n">weight</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span id="EscapeCalculator-332"><a href="#EscapeCalculator-332"><span class="linenos">332</span></a>                    <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;neg_log_ic50&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="EscapeCalculator-333"><a href="#EscapeCalculator-333"><span class="linenos">333</span></a>                    <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;reweight&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="EscapeCalculator-334"><a href="#EscapeCalculator-334"><span class="linenos">334</span></a>                <span class="p">),</span>
</span><span id="EscapeCalculator-335"><a href="#EscapeCalculator-335"><span class="linenos">335</span></a>            <span class="p">)</span>
</span><span id="EscapeCalculator-336"><a href="#EscapeCalculator-336"><span class="linenos">336</span></a>            <span class="p">[[</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;antibody_bind_retain&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">]]</span>
</span><span id="EscapeCalculator-337"><a href="#EscapeCalculator-337"><span class="linenos">337</span></a>            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="s2">&quot;escape&quot;</span><span class="p">]])</span>
</span><span id="EscapeCalculator-338"><a href="#EscapeCalculator-338"><span class="linenos">338</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="EscapeCalculator-339"><a href="#EscapeCalculator-339"><span class="linenos">339</span></a>                <span class="n">escape</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;escape&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span>
</span><span id="EscapeCalculator-340"><a href="#EscapeCalculator-340"><span class="linenos">340</span></a>                <span class="n">retained_escape</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;antibody_bind_retain&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;escape&quot;</span><span class="p">],</span>
</span><span id="EscapeCalculator-341"><a href="#EscapeCalculator-341"><span class="linenos">341</span></a>            <span class="p">)</span>
</span><span id="EscapeCalculator-342"><a href="#EscapeCalculator-342"><span class="linenos">342</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;site&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator-343"><a href="#EscapeCalculator-343"><span class="linenos">343</span></a>            <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
</span><span id="EscapeCalculator-344"><a href="#EscapeCalculator-344"><span class="linenos">344</span></a>                <span class="n">original_escape</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="s2">&quot;escape&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">),</span>
</span><span id="EscapeCalculator-345"><a href="#EscapeCalculator-345"><span class="linenos">345</span></a>                <span class="n">retained_escape</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="s2">&quot;retained_escape&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">),</span>
</span><span id="EscapeCalculator-346"><a href="#EscapeCalculator-346"><span class="linenos">346</span></a>            <span class="p">)</span>
</span><span id="EscapeCalculator-347"><a href="#EscapeCalculator-347"><span class="linenos">347</span></a>        <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;antibody&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
</span><span id="EscapeCalculator-348"><a href="#EscapeCalculator-348"><span class="linenos">348</span></a>        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="EscapeCalculator-349"><a href="#EscapeCalculator-349"><span class="linenos">349</span></a>
</span><span id="EscapeCalculator-350"><a href="#EscapeCalculator-350"><span class="linenos">350</span></a>    <span class="k">def</span> <span class="nf">binding_retained</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mutated_sites</span><span class="p">):</span>
</span><span id="EscapeCalculator-351"><a href="#EscapeCalculator-351"><span class="linenos">351</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fraction binding or neutralization retained after mutating indicated sites.</span>
</span><span id="EscapeCalculator-352"><a href="#EscapeCalculator-352"><span class="linenos">352</span></a>
</span><span id="EscapeCalculator-353"><a href="#EscapeCalculator-353"><span class="linenos">353</span></a><span class="sd">        Parameters</span>
</span><span id="EscapeCalculator-354"><a href="#EscapeCalculator-354"><span class="linenos">354</span></a><span class="sd">        ----------</span>
</span><span id="EscapeCalculator-355"><a href="#EscapeCalculator-355"><span class="linenos">355</span></a><span class="sd">        mutated_sites : array-like of integers</span>
</span><span id="EscapeCalculator-356"><a href="#EscapeCalculator-356"><span class="linenos">356</span></a><span class="sd">            List of mutated sites, must all be in :attr:`BindingCalculator.sites`.</span>
</span><span id="EscapeCalculator-357"><a href="#EscapeCalculator-357"><span class="linenos">357</span></a>
</span><span id="EscapeCalculator-358"><a href="#EscapeCalculator-358"><span class="linenos">358</span></a><span class="sd">        Returns</span>
</span><span id="EscapeCalculator-359"><a href="#EscapeCalculator-359"><span class="linenos">359</span></a><span class="sd">        -------</span>
</span><span id="EscapeCalculator-360"><a href="#EscapeCalculator-360"><span class="linenos">360</span></a><span class="sd">        float</span>
</span><span id="EscapeCalculator-361"><a href="#EscapeCalculator-361"><span class="linenos">361</span></a><span class="sd">            The fraction binding retained after these mutations.</span>
</span><span id="EscapeCalculator-362"><a href="#EscapeCalculator-362"><span class="linenos">362</span></a>
</span><span id="EscapeCalculator-363"><a href="#EscapeCalculator-363"><span class="linenos">363</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EscapeCalculator-364"><a href="#EscapeCalculator-364"><span class="linenos">364</span></a>        <span class="n">mutated_sites</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mutated_sites</span><span class="p">)</span>
</span><span id="EscapeCalculator-365"><a href="#EscapeCalculator-365"><span class="linenos">365</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">mutated_sites</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">):</span>
</span><span id="EscapeCalculator-366"><a href="#EscapeCalculator-366"><span class="linenos">366</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sites </span><span class="si">{</span><span class="n">mutated_sites</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="si">}</span><span class="s2"> not in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator-367"><a href="#EscapeCalculator-367"><span class="linenos">367</span></a>        <span class="n">retained</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EscapeCalculator-368"><a href="#EscapeCalculator-368"><span class="linenos">368</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="EscapeCalculator-369"><a href="#EscapeCalculator-369"><span class="linenos">369</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="EscapeCalculator-370"><a href="#EscapeCalculator-370"><span class="linenos">370</span></a>                <span class="n">mutated</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mutated_sites</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
</span><span id="EscapeCalculator-371"><a href="#EscapeCalculator-371"><span class="linenos">371</span></a>                <span class="n">site_bind_retain</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;escape&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;mutated&quot;</span><span class="p">],</span>
</span><span id="EscapeCalculator-372"><a href="#EscapeCalculator-372"><span class="linenos">372</span></a>            <span class="p">)</span>
</span><span id="EscapeCalculator-373"><a href="#EscapeCalculator-373"><span class="linenos">373</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;neg_log_ic50&quot;</span><span class="p">,</span> <span class="s2">&quot;reweight&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EscapeCalculator-374"><a href="#EscapeCalculator-374"><span class="linenos">374</span></a>            <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">antibody_bind_retain</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="s2">&quot;site_bind_retain&quot;</span><span class="p">,</span> <span class="s2">&quot;prod&quot;</span><span class="p">))</span>
</span><span id="EscapeCalculator-375"><a href="#EscapeCalculator-375"><span class="linenos">375</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="EscapeCalculator-376"><a href="#EscapeCalculator-376"><span class="linenos">376</span></a>                <span class="n">antibody_bind_retain</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;antibody_bind_retain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span>
</span><span id="EscapeCalculator-377"><a href="#EscapeCalculator-377"><span class="linenos">377</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mut_escape_strength</span>
</span><span id="EscapeCalculator-378"><a href="#EscapeCalculator-378"><span class="linenos">378</span></a>                <span class="p">),</span>
</span><span id="EscapeCalculator-379"><a href="#EscapeCalculator-379"><span class="linenos">379</span></a>                <span class="n">weight</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span id="EscapeCalculator-380"><a href="#EscapeCalculator-380"><span class="linenos">380</span></a>                    <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;neg_log_ic50&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="EscapeCalculator-381"><a href="#EscapeCalculator-381"><span class="linenos">381</span></a>                    <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;reweight&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="EscapeCalculator-382"><a href="#EscapeCalculator-382"><span class="linenos">382</span></a>                <span class="p">),</span>
</span><span id="EscapeCalculator-383"><a href="#EscapeCalculator-383"><span class="linenos">383</span></a>                <span class="n">weighted_antibody_bind_retain</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span id="EscapeCalculator-384"><a href="#EscapeCalculator-384"><span class="linenos">384</span></a>                    <span class="n">x</span><span class="p">[</span><span class="s2">&quot;antibody_bind_retain&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator-385"><a href="#EscapeCalculator-385"><span class="linenos">385</span></a>                <span class="p">),</span>
</span><span id="EscapeCalculator-386"><a href="#EscapeCalculator-386"><span class="linenos">386</span></a>            <span class="p">)</span>
</span><span id="EscapeCalculator-387"><a href="#EscapeCalculator-387"><span class="linenos">387</span></a>            <span class="p">[[</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="s2">&quot;weighted_antibody_bind_retain&quot;</span><span class="p">]]</span>
</span><span id="EscapeCalculator-388"><a href="#EscapeCalculator-388"><span class="linenos">388</span></a>            <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="EscapeCalculator-389"><a href="#EscapeCalculator-389"><span class="linenos">389</span></a>        <span class="p">)</span>
</span><span id="EscapeCalculator-390"><a href="#EscapeCalculator-390"><span class="linenos">390</span></a>        <span class="k">return</span> <span class="n">retained</span><span class="p">[</span><span class="s2">&quot;weighted_antibody_bind_retain&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">retained</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Calculates residual polyclonal antibody binding after some mutations.</p>

<p>The calculator is implemented interactively at
<a href="https://jbloomlab.github.io/SARS2-RBD-escape-calc/">https://jbloomlab.github.io/SARS2-RBD-escape-calc </a></p>

<p>By default, this command-line calculator will exactly implement the calculations of the
interactive calculator with default settings. You can pass parameters to override
the default settings.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>escape</strong> (str):
Path or URL of CSV containing the escape data.</li>
<li><strong>antibody_ic50s</strong> (str):
Path or URL of CSV containing the antibody IC50s.</li>
<li><strong>antibody_sources</strong> (str):
Path or URL of CSV containing the antibody sources.</li>
<li><strong>antibody_reweighting</strong> (str):
Path or URL of CSV containing the antibody reweightings.</li>
<li><strong>config</strong> (str):
Path or URL of YAML file containing initial settings.</li>
<li><strong>mut_escape_strength</strong> (None or float):
If not <code>None</code>, override default <code>init_mutation_escape_strength</code> in <code>config</code>.</li>
<li><strong>weight_by_neg_log_ic50</strong> (None or bool):
If not <code>None</code>, override default <code>init_weight_by_neg_log_IC50</code> in <code>config</code>.</li>
<li><strong>study</strong> (None or str):
If not <code>None</code>, override default <code>init_study</code> in <code>config</code>.</li>
<li><strong>virus</strong> (None or str):
If not <code>None</code>, override default <code>init_virus</code> in <code>config</code>.</li>
<li><strong>sources</strong> (None or dict):
If not <code>None</code>, override default <code>init_sources</code> in <code>config</code>.</li>
<li><strong>reweight</strong> (None or bool):
If not <code>None</code>, override default <code>init_reweight</code> in <code>config</code>.</li>
</ul>

<h6 id="example">Example</h6>

<p>Initialize the calculator:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">calc</span> <span class="o">=</span> <span class="n">EscapeCalculator</span><span class="p">()</span>
</code></pre>
</div>

<p>Calculate escape at sites after some mutations:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">sites_of_interest</span> <span class="o">=</span> <span class="p">[</span><span class="mi">403</span><span class="p">,</span> <span class="mi">440</span><span class="p">,</span> <span class="mi">484</span><span class="p">,</span> <span class="mi">498</span><span class="p">,</span> <span class="mi">505</span><span class="p">,</span> <span class="mi">510</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">calc</span><span class="o">.</span><span class="n">escape_per_site</span><span class="p">([</span><span class="mi">440</span><span class="p">,</span> <span class="mi">505</span><span class="p">])</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;site in @sites_of_interest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">     site  original_escape  retained_escape</span>
<span class="go">69    403            0.105            0.030</span>
<span class="go">101   440            0.162            0.018</span>
<span class="go">143   484            0.043            0.032</span>
<span class="go">156   498            0.169            0.076</span>
<span class="go">163   505            0.208            0.022</span>
<span class="go">167   510            0.001            0.001</span>
</code></pre>
</div>

<p>Calculate overall neutralization retained after no mutations or some mutations:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">calc</span><span class="o">.</span><span class="n">binding_retained</span><span class="p">([])</span> <span class="o">==</span> <span class="mf">1.0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">calc</span><span class="o">.</span><span class="n">binding_retained</span><span class="p">([</span><span class="mi">440</span><span class="p">,</span> <span class="mi">505</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.545</span>
</code></pre>
</div>

<p>Now repeat tests with some non-default options:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">calc2</span> <span class="o">=</span> <span class="n">EscapeCalculator</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">mut_escape_strength</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">weight_by_neg_log_ic50</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">study</span><span class="o">=</span><span class="s2">&quot;Cao et al, 2022, Nature&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">virus</span><span class="o">=</span><span class="s2">&quot;D614G&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">sources</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;include_exclude&quot;</span><span class="p">:</span> <span class="s2">&quot;include&quot;</span><span class="p">,</span> <span class="s2">&quot;sources&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;WT convalescents&quot;</span><span class="p">]},</span>
<span class="gp">... </span><span class="p">)</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">calc2</span><span class="o">.</span><span class="n">escape_per_site</span><span class="p">([</span><span class="mi">484</span><span class="p">])</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;site in @sites_of_interest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">     site  original_escape  retained_escape</span>
<span class="go">62    403            0.006            0.006</span>
<span class="go">84    440            0.008            0.007</span>
<span class="go">123   484            0.212            0.029</span>
<span class="go">134   498            0.009            0.008</span>
<span class="go">141   505            0.002            0.002</span>
<span class="go">144   510            0.000            0.000</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">calc2</span><span class="o">.</span><span class="n">binding_retained</span><span class="p">([</span><span class="mi">484</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.788</span>
</code></pre>
</div>
</div>


                            <div id="EscapeCalculator.__init__" class="classattr">
                                        <input id="EscapeCalculator.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">EscapeCalculator</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">escape</span><span class="o">=</span><span class="s1">&#39;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/results/escape.csv&#39;</span>,</span><span class="param">	<span class="n">antibody_ic50s</span><span class="o">=</span><span class="s1">&#39;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/results/antibody_IC50s.csv&#39;</span>,</span><span class="param">	<span class="n">antibody_sources</span><span class="o">=</span><span class="s1">&#39;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/results/antibody_sources.csv&#39;</span>,</span><span class="param">	<span class="n">antibody_reweighting</span><span class="o">=</span><span class="s1">&#39;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/results/antibody_reweighting.csv&#39;</span>,</span><span class="param">	<span class="n">config</span><span class="o">=</span><span class="s1">&#39;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/config.yaml&#39;</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">mut_escape_strength</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">weight_by_neg_log_ic50</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">study</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">virus</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">sources</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">reweight</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="EscapeCalculator.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EscapeCalculator.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EscapeCalculator.__init__-163"><a href="#EscapeCalculator.__init__-163"><span class="linenos">163</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="EscapeCalculator.__init__-164"><a href="#EscapeCalculator.__init__-164"><span class="linenos">164</span></a>        <span class="n">escape</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/results/escape.csv&quot;</span><span class="p">,</span>
</span><span id="EscapeCalculator.__init__-165"><a href="#EscapeCalculator.__init__-165"><span class="linenos">165</span></a>        <span class="n">antibody_ic50s</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/results/antibody_IC50s.csv&quot;</span><span class="p">,</span>
</span><span id="EscapeCalculator.__init__-166"><a href="#EscapeCalculator.__init__-166"><span class="linenos">166</span></a>        <span class="n">antibody_sources</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/results/antibody_sources.csv&quot;</span><span class="p">,</span>
</span><span id="EscapeCalculator.__init__-167"><a href="#EscapeCalculator.__init__-167"><span class="linenos">167</span></a>        <span class="n">antibody_reweighting</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/results/antibody_reweighting.csv&quot;</span><span class="p">,</span>
</span><span id="EscapeCalculator.__init__-168"><a href="#EscapeCalculator.__init__-168"><span class="linenos">168</span></a>        <span class="n">config</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/jbloomlab/SARS2-RBD-escape-calc/main/config.yaml&quot;</span><span class="p">,</span>
</span><span id="EscapeCalculator.__init__-169"><a href="#EscapeCalculator.__init__-169"><span class="linenos">169</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="EscapeCalculator.__init__-170"><a href="#EscapeCalculator.__init__-170"><span class="linenos">170</span></a>        <span class="n">mut_escape_strength</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="EscapeCalculator.__init__-171"><a href="#EscapeCalculator.__init__-171"><span class="linenos">171</span></a>        <span class="n">weight_by_neg_log_ic50</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="EscapeCalculator.__init__-172"><a href="#EscapeCalculator.__init__-172"><span class="linenos">172</span></a>        <span class="n">study</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="EscapeCalculator.__init__-173"><a href="#EscapeCalculator.__init__-173"><span class="linenos">173</span></a>        <span class="n">virus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="EscapeCalculator.__init__-174"><a href="#EscapeCalculator.__init__-174"><span class="linenos">174</span></a>        <span class="n">sources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="EscapeCalculator.__init__-175"><a href="#EscapeCalculator.__init__-175"><span class="linenos">175</span></a>        <span class="n">reweight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="EscapeCalculator.__init__-176"><a href="#EscapeCalculator.__init__-176"><span class="linenos">176</span></a>    <span class="p">):</span>
</span><span id="EscapeCalculator.__init__-177"><a href="#EscapeCalculator.__init__-177"><span class="linenos">177</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;See main class docstring.&quot;&quot;&quot;</span>
</span><span id="EscapeCalculator.__init__-178"><a href="#EscapeCalculator.__init__-178"><span class="linenos">178</span></a>        <span class="c1"># read input data </span>
</span><span id="EscapeCalculator.__init__-179"><a href="#EscapeCalculator.__init__-179"><span class="linenos">179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">escape</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">escape</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-180"><a href="#EscapeCalculator.__init__-180"><span class="linenos">180</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="s2">&quot;escape&quot;</span><span class="p">}</span>
</span><span id="EscapeCalculator.__init__-181"><a href="#EscapeCalculator.__init__-181"><span class="linenos">181</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">escape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="s2">&quot;escape&quot;</span><span class="p">]))</span>
</span><span id="EscapeCalculator.__init__-182"><a href="#EscapeCalculator.__init__-182"><span class="linenos">182</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="EscapeCalculator.__init__-183"><a href="#EscapeCalculator.__init__-183"><span class="linenos">183</span></a>        <span class="n">antibodies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">escape</span><span class="p">[</span><span class="s2">&quot;antibody&quot;</span><span class="p">])</span>
</span><span id="EscapeCalculator.__init__-184"><a href="#EscapeCalculator.__init__-184"><span class="linenos">184</span></a>
</span><span id="EscapeCalculator.__init__-185"><a href="#EscapeCalculator.__init__-185"><span class="linenos">185</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">antibody_ic50s</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-186"><a href="#EscapeCalculator.__init__-186"><span class="linenos">186</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;virus&quot;</span><span class="p">,</span> <span class="s2">&quot;IC50&quot;</span><span class="p">}</span>
</span><span id="EscapeCalculator.__init__-187"><a href="#EscapeCalculator.__init__-187"><span class="linenos">187</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="EscapeCalculator.__init__-188"><a href="#EscapeCalculator.__init__-188"><span class="linenos">188</span></a>            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-189"><a href="#EscapeCalculator.__init__-189"><span class="linenos">189</span></a>            <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;virus&quot;</span><span class="p">,</span> <span class="s2">&quot;IC50&quot;</span><span class="p">]))</span>
</span><span id="EscapeCalculator.__init__-190"><a href="#EscapeCalculator.__init__-190"><span class="linenos">190</span></a>        <span class="p">)</span>
</span><span id="EscapeCalculator.__init__-191"><a href="#EscapeCalculator.__init__-191"><span class="linenos">191</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="p">[</span><span class="s2">&quot;IC50&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">10</span>
</span><span id="EscapeCalculator.__init__-192"><a href="#EscapeCalculator.__init__-192"><span class="linenos">192</span></a>        <span class="k">assert</span> <span class="n">antibodies</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="p">[</span><span class="s2">&quot;antibody&quot;</span><span class="p">])</span>
</span><span id="EscapeCalculator.__init__-193"><a href="#EscapeCalculator.__init__-193"><span class="linenos">193</span></a>
</span><span id="EscapeCalculator.__init__-194"><a href="#EscapeCalculator.__init__-194"><span class="linenos">194</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">antibody_sources</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-195"><a href="#EscapeCalculator.__init__-195"><span class="linenos">195</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;study&quot;</span><span class="p">}</span>
</span><span id="EscapeCalculator.__init__-196"><a href="#EscapeCalculator.__init__-196"><span class="linenos">196</span></a>        <span class="k">assert</span> <span class="p">(</span>
</span><span id="EscapeCalculator.__init__-197"><a href="#EscapeCalculator.__init__-197"><span class="linenos">197</span></a>            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-198"><a href="#EscapeCalculator.__init__-198"><span class="linenos">198</span></a>            <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;study&quot;</span><span class="p">]))</span>
</span><span id="EscapeCalculator.__init__-199"><a href="#EscapeCalculator.__init__-199"><span class="linenos">199</span></a>            <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">antibodies</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-200"><a href="#EscapeCalculator.__init__-200"><span class="linenos">200</span></a>        <span class="p">)</span>
</span><span id="EscapeCalculator.__init__-201"><a href="#EscapeCalculator.__init__-201"><span class="linenos">201</span></a>        <span class="k">assert</span> <span class="n">antibodies</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span><span class="p">[</span><span class="s2">&quot;antibody&quot;</span><span class="p">])</span>
</span><span id="EscapeCalculator.__init__-202"><a href="#EscapeCalculator.__init__-202"><span class="linenos">202</span></a>
</span><span id="EscapeCalculator.__init__-203"><a href="#EscapeCalculator.__init__-203"><span class="linenos">203</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">antibody_reweighting</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">antibody_reweighting</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-204"><a href="#EscapeCalculator.__init__-204"><span class="linenos">204</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_reweighting</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;reweight&quot;</span><span class="p">}</span>
</span><span id="EscapeCalculator.__init__-205"><a href="#EscapeCalculator.__init__-205"><span class="linenos">205</span></a>        <span class="k">assert</span> <span class="n">antibodies</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_reweighting</span><span class="p">[</span><span class="s2">&quot;antibody&quot;</span><span class="p">])</span>
</span><span id="EscapeCalculator.__init__-206"><a href="#EscapeCalculator.__init__-206"><span class="linenos">206</span></a>
</span><span id="EscapeCalculator.__init__-207"><a href="#EscapeCalculator.__init__-207"><span class="linenos">207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EscapeCalculator.__init__-208"><a href="#EscapeCalculator.__init__-208"><span class="linenos">208</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">escape</span>
</span><span id="EscapeCalculator.__init__-209"><a href="#EscapeCalculator.__init__-209"><span class="linenos">209</span></a>            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_ic50s</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;antibody&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-210"><a href="#EscapeCalculator.__init__-210"><span class="linenos">210</span></a>            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_sources</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;antibody&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-211"><a href="#EscapeCalculator.__init__-211"><span class="linenos">211</span></a>            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antibody_reweighting</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-212"><a href="#EscapeCalculator.__init__-212"><span class="linenos">212</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">reweight</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;reweight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="EscapeCalculator.__init__-213"><a href="#EscapeCalculator.__init__-213"><span class="linenos">213</span></a>        <span class="p">)</span>
</span><span id="EscapeCalculator.__init__-214"><a href="#EscapeCalculator.__init__-214"><span class="linenos">214</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="EscapeCalculator.__init__-215"><a href="#EscapeCalculator.__init__-215"><span class="linenos">215</span></a>
</span><span id="EscapeCalculator.__init__-216"><a href="#EscapeCalculator.__init__-216"><span class="linenos">216</span></a>        <span class="c1"># get initial config</span>
</span><span id="EscapeCalculator.__init__-217"><a href="#EscapeCalculator.__init__-217"><span class="linenos">217</span></a>        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
</span><span id="EscapeCalculator.__init__-218"><a href="#EscapeCalculator.__init__-218"><span class="linenos">218</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-219"><a href="#EscapeCalculator.__init__-219"><span class="linenos">219</span></a>            <span class="n">config_text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-220"><a href="#EscapeCalculator.__init__-220"><span class="linenos">220</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-221"><a href="#EscapeCalculator.__init__-221"><span class="linenos">221</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-222"><a href="#EscapeCalculator.__init__-222"><span class="linenos">222</span></a>                <span class="n">config_text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="EscapeCalculator.__init__-223"><a href="#EscapeCalculator.__init__-223"><span class="linenos">223</span></a>        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">config_text</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-224"><a href="#EscapeCalculator.__init__-224"><span class="linenos">224</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sites</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;sites&quot;</span><span class="p">][</span><span class="s2">&quot;start&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;sites&quot;</span><span class="p">][</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="EscapeCalculator.__init__-225"><a href="#EscapeCalculator.__init__-225"><span class="linenos">225</span></a>        <span class="n">studies</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;studies&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator.__init__-226"><a href="#EscapeCalculator.__init__-226"><span class="linenos">226</span></a>        <span class="n">studies_rev</span> <span class="o">=</span> <span class="p">{</span><span class="n">value</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">studies</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="EscapeCalculator.__init__-227"><a href="#EscapeCalculator.__init__-227"><span class="linenos">227</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;study&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">studies</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-228"><a href="#EscapeCalculator.__init__-228"><span class="linenos">228</span></a>
</span><span id="EscapeCalculator.__init__-229"><a href="#EscapeCalculator.__init__-229"><span class="linenos">229</span></a>        <span class="k">if</span> <span class="n">mut_escape_strength</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-230"><a href="#EscapeCalculator.__init__-230"><span class="linenos">230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mut_escape_strength</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_mutation_escape_strength&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator.__init__-231"><a href="#EscapeCalculator.__init__-231"><span class="linenos">231</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-232"><a href="#EscapeCalculator.__init__-232"><span class="linenos">232</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mut_escape_strength</span> <span class="o">=</span> <span class="n">mut_escape_strength</span>
</span><span id="EscapeCalculator.__init__-233"><a href="#EscapeCalculator.__init__-233"><span class="linenos">233</span></a>
</span><span id="EscapeCalculator.__init__-234"><a href="#EscapeCalculator.__init__-234"><span class="linenos">234</span></a>        <span class="k">if</span> <span class="n">weight_by_neg_log_ic50</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-235"><a href="#EscapeCalculator.__init__-235"><span class="linenos">235</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_weight_by_neg_log_IC50&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator.__init__-236"><a href="#EscapeCalculator.__init__-236"><span class="linenos">236</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-237"><a href="#EscapeCalculator.__init__-237"><span class="linenos">237</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span> <span class="o">=</span> <span class="n">weight_by_neg_log_ic50</span>
</span><span id="EscapeCalculator.__init__-238"><a href="#EscapeCalculator.__init__-238"><span class="linenos">238</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span>
</span><span id="EscapeCalculator.__init__-239"><a href="#EscapeCalculator.__init__-239"><span class="linenos">239</span></a>
</span><span id="EscapeCalculator.__init__-240"><a href="#EscapeCalculator.__init__-240"><span class="linenos">240</span></a>        <span class="k">if</span> <span class="n">study</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-241"><a href="#EscapeCalculator.__init__-241"><span class="linenos">241</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">study</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_study&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator.__init__-242"><a href="#EscapeCalculator.__init__-242"><span class="linenos">242</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-243"><a href="#EscapeCalculator.__init__-243"><span class="linenos">243</span></a>            <span class="k">if</span> <span class="n">study</span> <span class="o">==</span> <span class="s2">&quot;any&quot;</span> <span class="ow">or</span> <span class="n">study</span> <span class="ow">in</span> <span class="n">studies</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-244"><a href="#EscapeCalculator.__init__-244"><span class="linenos">244</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">study</span> <span class="o">=</span> <span class="n">study</span>
</span><span id="EscapeCalculator.__init__-245"><a href="#EscapeCalculator.__init__-245"><span class="linenos">245</span></a>            <span class="k">elif</span> <span class="n">study</span> <span class="ow">in</span> <span class="n">studies_rev</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-246"><a href="#EscapeCalculator.__init__-246"><span class="linenos">246</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">study</span> <span class="o">=</span> <span class="n">studies_rev</span><span class="p">[</span><span class="n">study</span><span class="p">]</span>
</span><span id="EscapeCalculator.__init__-247"><a href="#EscapeCalculator.__init__-247"><span class="linenos">247</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-248"><a href="#EscapeCalculator.__init__-248"><span class="linenos">248</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid </span><span class="si">{</span><span class="n">study</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-249"><a href="#EscapeCalculator.__init__-249"><span class="linenos">249</span></a>
</span><span id="EscapeCalculator.__init__-250"><a href="#EscapeCalculator.__init__-250"><span class="linenos">250</span></a>        <span class="k">if</span> <span class="n">virus</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-251"><a href="#EscapeCalculator.__init__-251"><span class="linenos">251</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virus</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_virus&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator.__init__-252"><a href="#EscapeCalculator.__init__-252"><span class="linenos">252</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-253"><a href="#EscapeCalculator.__init__-253"><span class="linenos">253</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">virus</span> <span class="o">=</span> <span class="n">virus</span>
</span><span id="EscapeCalculator.__init__-254"><a href="#EscapeCalculator.__init__-254"><span class="linenos">254</span></a>
</span><span id="EscapeCalculator.__init__-255"><a href="#EscapeCalculator.__init__-255"><span class="linenos">255</span></a>        <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-256"><a href="#EscapeCalculator.__init__-256"><span class="linenos">256</span></a>            <span class="n">sources</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_sources&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator.__init__-257"><a href="#EscapeCalculator.__init__-257"><span class="linenos">257</span></a>        <span class="n">include_exclude</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;include_exclude&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator.__init__-258"><a href="#EscapeCalculator.__init__-258"><span class="linenos">258</span></a>        <span class="n">sources_list</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s2">&quot;sources&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator.__init__-259"><a href="#EscapeCalculator.__init__-259"><span class="linenos">259</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])</span>
</span><span id="EscapeCalculator.__init__-260"><a href="#EscapeCalculator.__init__-260"><span class="linenos">260</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">sources_list</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="si">=}</span><span class="se">\n</span><span class="si">{</span><span class="n">sources_list</span><span class="si">=}</span><span class="s2">&quot;</span>
</span><span id="EscapeCalculator.__init__-261"><a href="#EscapeCalculator.__init__-261"><span class="linenos">261</span></a>        <span class="k">if</span> <span class="n">include_exclude</span> <span class="o">==</span> <span class="s2">&quot;exclude&quot;</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-262"><a href="#EscapeCalculator.__init__-262"><span class="linenos">262</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">sources_list</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-263"><a href="#EscapeCalculator.__init__-263"><span class="linenos">263</span></a>        <span class="k">elif</span> <span class="n">include_exclude</span> <span class="o">==</span> <span class="s2">&quot;include&quot;</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-264"><a href="#EscapeCalculator.__init__-264"><span class="linenos">264</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sources_list</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-265"><a href="#EscapeCalculator.__init__-265"><span class="linenos">265</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-266"><a href="#EscapeCalculator.__init__-266"><span class="linenos">266</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid </span><span class="si">{</span><span class="n">include_exclude</span><span class="si">=}</span><span class="s2"> in </span><span class="si">{</span><span class="n">sources</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-267"><a href="#EscapeCalculator.__init__-267"><span class="linenos">267</span></a>
</span><span id="EscapeCalculator.__init__-268"><a href="#EscapeCalculator.__init__-268"><span class="linenos">268</span></a>        <span class="k">if</span> <span class="n">reweight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-269"><a href="#EscapeCalculator.__init__-269"><span class="linenos">269</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reweight</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init_reweight&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator.__init__-270"><a href="#EscapeCalculator.__init__-270"><span class="linenos">270</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-271"><a href="#EscapeCalculator.__init__-271"><span class="linenos">271</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reweight</span> <span class="o">=</span> <span class="n">reweight</span>
</span><span id="EscapeCalculator.__init__-272"><a href="#EscapeCalculator.__init__-272"><span class="linenos">272</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reweight</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight</span>
</span><span id="EscapeCalculator.__init__-273"><a href="#EscapeCalculator.__init__-273"><span class="linenos">273</span></a>
</span><span id="EscapeCalculator.__init__-274"><a href="#EscapeCalculator.__init__-274"><span class="linenos">274</span></a>        <span class="c1"># filter data</span>
</span><span id="EscapeCalculator.__init__-275"><a href="#EscapeCalculator.__init__-275"><span class="linenos">275</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">study</span> <span class="o">!=</span> <span class="s2">&quot;any&quot;</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-276"><a href="#EscapeCalculator.__init__-276"><span class="linenos">276</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">study</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;study&quot;</span><span class="p">])</span>
</span><span id="EscapeCalculator.__init__-277"><a href="#EscapeCalculator.__init__-277"><span class="linenos">277</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;study == @self.study&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;study&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-278"><a href="#EscapeCalculator.__init__-278"><span class="linenos">278</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EscapeCalculator.__init__-279"><a href="#EscapeCalculator.__init__-279"><span class="linenos">279</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;study&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-280"><a href="#EscapeCalculator.__init__-280"><span class="linenos">280</span></a>
</span><span id="EscapeCalculator.__init__-281"><a href="#EscapeCalculator.__init__-281"><span class="linenos">281</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">virus</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;virus&quot;</span><span class="p">])</span>
</span><span id="EscapeCalculator.__init__-282"><a href="#EscapeCalculator.__init__-282"><span class="linenos">282</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;virus == @self.virus&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;virus&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-283"><a href="#EscapeCalculator.__init__-283"><span class="linenos">283</span></a>
</span><span id="EscapeCalculator.__init__-284"><a href="#EscapeCalculator.__init__-284"><span class="linenos">284</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;source in @self.sources&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;source&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-285"><a href="#EscapeCalculator.__init__-285"><span class="linenos">285</span></a>
</span><span id="EscapeCalculator.__init__-286"><a href="#EscapeCalculator.__init__-286"><span class="linenos">286</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="s2">&quot;escape&quot;</span><span class="p">,</span> <span class="s2">&quot;IC50&quot;</span><span class="p">,</span> <span class="s2">&quot;reweight&quot;</span><span class="p">}</span>
</span><span id="EscapeCalculator.__init__-287"><a href="#EscapeCalculator.__init__-287"><span class="linenos">287</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>
</span><span id="EscapeCalculator.__init__-288"><a href="#EscapeCalculator.__init__-288"><span class="linenos">288</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EscapeCalculator.__init__-289"><a href="#EscapeCalculator.__init__-289"><span class="linenos">289</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="EscapeCalculator.__init__-290"><a href="#EscapeCalculator.__init__-290"><span class="linenos">290</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">neg_log_ic50</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;IC50&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>
</span><span id="EscapeCalculator.__init__-291"><a href="#EscapeCalculator.__init__-291"><span class="linenos">291</span></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;IC50&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-292"><a href="#EscapeCalculator.__init__-292"><span class="linenos">292</span></a>        <span class="p">)</span>
</span><span id="EscapeCalculator.__init__-293"><a href="#EscapeCalculator.__init__-293"><span class="linenos">293</span></a>
</span><span id="EscapeCalculator.__init__-294"><a href="#EscapeCalculator.__init__-294"><span class="linenos">294</span></a>        <span class="n">max_escape_per_antibody</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EscapeCalculator.__init__-295"><a href="#EscapeCalculator.__init__-295"><span class="linenos">295</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="EscapeCalculator.__init__-296"><a href="#EscapeCalculator.__init__-296"><span class="linenos">296</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;antibody&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator.__init__-297"><a href="#EscapeCalculator.__init__-297"><span class="linenos">297</span></a>            <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">max_escape</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="s2">&quot;escape&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">))</span>
</span><span id="EscapeCalculator.__init__-298"><a href="#EscapeCalculator.__init__-298"><span class="linenos">298</span></a>        <span class="p">)</span>
</span><span id="EscapeCalculator.__init__-299"><a href="#EscapeCalculator.__init__-299"><span class="linenos">299</span></a>        <span class="k">assert</span> <span class="p">(</span><span class="n">max_escape_per_antibody</span><span class="p">[</span><span class="s2">&quot;max_escape&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>See main class docstring.</p>
</div>


                            </div>
                            <div id="EscapeCalculator.escape_per_site" class="classattr">
                                        <input id="EscapeCalculator.escape_per_site-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">escape_per_site</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mutated_sites</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="EscapeCalculator.escape_per_site-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EscapeCalculator.escape_per_site"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EscapeCalculator.escape_per_site-301"><a href="#EscapeCalculator.escape_per_site-301"><span class="linenos">301</span></a>    <span class="k">def</span> <span class="nf">escape_per_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mutated_sites</span><span class="p">):</span>
</span><span id="EscapeCalculator.escape_per_site-302"><a href="#EscapeCalculator.escape_per_site-302"><span class="linenos">302</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Escape at each site after mutating indicated sites.</span>
</span><span id="EscapeCalculator.escape_per_site-303"><a href="#EscapeCalculator.escape_per_site-303"><span class="linenos">303</span></a>
</span><span id="EscapeCalculator.escape_per_site-304"><a href="#EscapeCalculator.escape_per_site-304"><span class="linenos">304</span></a><span class="sd">        Parameters</span>
</span><span id="EscapeCalculator.escape_per_site-305"><a href="#EscapeCalculator.escape_per_site-305"><span class="linenos">305</span></a><span class="sd">        ----------</span>
</span><span id="EscapeCalculator.escape_per_site-306"><a href="#EscapeCalculator.escape_per_site-306"><span class="linenos">306</span></a><span class="sd">        mutated_sites : array-like of integers</span>
</span><span id="EscapeCalculator.escape_per_site-307"><a href="#EscapeCalculator.escape_per_site-307"><span class="linenos">307</span></a><span class="sd">            List of mutated sites.</span>
</span><span id="EscapeCalculator.escape_per_site-308"><a href="#EscapeCalculator.escape_per_site-308"><span class="linenos">308</span></a>
</span><span id="EscapeCalculator.escape_per_site-309"><a href="#EscapeCalculator.escape_per_site-309"><span class="linenos">309</span></a><span class="sd">        Returns</span>
</span><span id="EscapeCalculator.escape_per_site-310"><a href="#EscapeCalculator.escape_per_site-310"><span class="linenos">310</span></a><span class="sd">        -------</span>
</span><span id="EscapeCalculator.escape_per_site-311"><a href="#EscapeCalculator.escape_per_site-311"><span class="linenos">311</span></a><span class="sd">        pandas.DataFrame</span>
</span><span id="EscapeCalculator.escape_per_site-312"><a href="#EscapeCalculator.escape_per_site-312"><span class="linenos">312</span></a><span class="sd">            For each site, gives the original escape and the escape</span>
</span><span id="EscapeCalculator.escape_per_site-313"><a href="#EscapeCalculator.escape_per_site-313"><span class="linenos">313</span></a><span class="sd">            retained after mutations.</span>
</span><span id="EscapeCalculator.escape_per_site-314"><a href="#EscapeCalculator.escape_per_site-314"><span class="linenos">314</span></a>
</span><span id="EscapeCalculator.escape_per_site-315"><a href="#EscapeCalculator.escape_per_site-315"><span class="linenos">315</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EscapeCalculator.escape_per_site-316"><a href="#EscapeCalculator.escape_per_site-316"><span class="linenos">316</span></a>        <span class="n">mutated_sites</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mutated_sites</span><span class="p">)</span>
</span><span id="EscapeCalculator.escape_per_site-317"><a href="#EscapeCalculator.escape_per_site-317"><span class="linenos">317</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">mutated_sites</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">):</span>
</span><span id="EscapeCalculator.escape_per_site-318"><a href="#EscapeCalculator.escape_per_site-318"><span class="linenos">318</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sites </span><span class="si">{</span><span class="n">mutated_sites</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="si">}</span><span class="s2"> not in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator.escape_per_site-319"><a href="#EscapeCalculator.escape_per_site-319"><span class="linenos">319</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EscapeCalculator.escape_per_site-320"><a href="#EscapeCalculator.escape_per_site-320"><span class="linenos">320</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="EscapeCalculator.escape_per_site-321"><a href="#EscapeCalculator.escape_per_site-321"><span class="linenos">321</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="EscapeCalculator.escape_per_site-322"><a href="#EscapeCalculator.escape_per_site-322"><span class="linenos">322</span></a>                <span class="n">mutated</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mutated_sites</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
</span><span id="EscapeCalculator.escape_per_site-323"><a href="#EscapeCalculator.escape_per_site-323"><span class="linenos">323</span></a>                <span class="n">site_bind_retain</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;escape&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;mutated&quot;</span><span class="p">],</span>
</span><span id="EscapeCalculator.escape_per_site-324"><a href="#EscapeCalculator.escape_per_site-324"><span class="linenos">324</span></a>            <span class="p">)</span>
</span><span id="EscapeCalculator.escape_per_site-325"><a href="#EscapeCalculator.escape_per_site-325"><span class="linenos">325</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;neg_log_ic50&quot;</span><span class="p">,</span> <span class="s2">&quot;reweight&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EscapeCalculator.escape_per_site-326"><a href="#EscapeCalculator.escape_per_site-326"><span class="linenos">326</span></a>            <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">antibody_bind_retain</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="s2">&quot;site_bind_retain&quot;</span><span class="p">,</span> <span class="s2">&quot;prod&quot;</span><span class="p">))</span>
</span><span id="EscapeCalculator.escape_per_site-327"><a href="#EscapeCalculator.escape_per_site-327"><span class="linenos">327</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="EscapeCalculator.escape_per_site-328"><a href="#EscapeCalculator.escape_per_site-328"><span class="linenos">328</span></a>                <span class="n">antibody_bind_retain</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;antibody_bind_retain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span>
</span><span id="EscapeCalculator.escape_per_site-329"><a href="#EscapeCalculator.escape_per_site-329"><span class="linenos">329</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mut_escape_strength</span>
</span><span id="EscapeCalculator.escape_per_site-330"><a href="#EscapeCalculator.escape_per_site-330"><span class="linenos">330</span></a>                <span class="p">),</span>
</span><span id="EscapeCalculator.escape_per_site-331"><a href="#EscapeCalculator.escape_per_site-331"><span class="linenos">331</span></a>                <span class="n">weight</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span id="EscapeCalculator.escape_per_site-332"><a href="#EscapeCalculator.escape_per_site-332"><span class="linenos">332</span></a>                    <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;neg_log_ic50&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="EscapeCalculator.escape_per_site-333"><a href="#EscapeCalculator.escape_per_site-333"><span class="linenos">333</span></a>                    <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;reweight&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="EscapeCalculator.escape_per_site-334"><a href="#EscapeCalculator.escape_per_site-334"><span class="linenos">334</span></a>                <span class="p">),</span>
</span><span id="EscapeCalculator.escape_per_site-335"><a href="#EscapeCalculator.escape_per_site-335"><span class="linenos">335</span></a>            <span class="p">)</span>
</span><span id="EscapeCalculator.escape_per_site-336"><a href="#EscapeCalculator.escape_per_site-336"><span class="linenos">336</span></a>            <span class="p">[[</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;antibody_bind_retain&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">]]</span>
</span><span id="EscapeCalculator.escape_per_site-337"><a href="#EscapeCalculator.escape_per_site-337"><span class="linenos">337</span></a>            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="s2">&quot;escape&quot;</span><span class="p">]])</span>
</span><span id="EscapeCalculator.escape_per_site-338"><a href="#EscapeCalculator.escape_per_site-338"><span class="linenos">338</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="EscapeCalculator.escape_per_site-339"><a href="#EscapeCalculator.escape_per_site-339"><span class="linenos">339</span></a>                <span class="n">escape</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;escape&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span>
</span><span id="EscapeCalculator.escape_per_site-340"><a href="#EscapeCalculator.escape_per_site-340"><span class="linenos">340</span></a>                <span class="n">retained_escape</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;antibody_bind_retain&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;escape&quot;</span><span class="p">],</span>
</span><span id="EscapeCalculator.escape_per_site-341"><a href="#EscapeCalculator.escape_per_site-341"><span class="linenos">341</span></a>            <span class="p">)</span>
</span><span id="EscapeCalculator.escape_per_site-342"><a href="#EscapeCalculator.escape_per_site-342"><span class="linenos">342</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;site&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator.escape_per_site-343"><a href="#EscapeCalculator.escape_per_site-343"><span class="linenos">343</span></a>            <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
</span><span id="EscapeCalculator.escape_per_site-344"><a href="#EscapeCalculator.escape_per_site-344"><span class="linenos">344</span></a>                <span class="n">original_escape</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="s2">&quot;escape&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">),</span>
</span><span id="EscapeCalculator.escape_per_site-345"><a href="#EscapeCalculator.escape_per_site-345"><span class="linenos">345</span></a>                <span class="n">retained_escape</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="s2">&quot;retained_escape&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">),</span>
</span><span id="EscapeCalculator.escape_per_site-346"><a href="#EscapeCalculator.escape_per_site-346"><span class="linenos">346</span></a>            <span class="p">)</span>
</span><span id="EscapeCalculator.escape_per_site-347"><a href="#EscapeCalculator.escape_per_site-347"><span class="linenos">347</span></a>        <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;antibody&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
</span><span id="EscapeCalculator.escape_per_site-348"><a href="#EscapeCalculator.escape_per_site-348"><span class="linenos">348</span></a>        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Escape at each site after mutating indicated sites.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>mutated_sites</strong> (array-like of integers):
List of mutated sites.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>pandas.DataFrame</strong>: For each site, gives the original escape and the escape
retained after mutations.</li>
</ul>
</div>


                            </div>
                            <div id="EscapeCalculator.binding_retained" class="classattr">
                                        <input id="EscapeCalculator.binding_retained-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">binding_retained</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mutated_sites</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="EscapeCalculator.binding_retained-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EscapeCalculator.binding_retained"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EscapeCalculator.binding_retained-350"><a href="#EscapeCalculator.binding_retained-350"><span class="linenos">350</span></a>    <span class="k">def</span> <span class="nf">binding_retained</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mutated_sites</span><span class="p">):</span>
</span><span id="EscapeCalculator.binding_retained-351"><a href="#EscapeCalculator.binding_retained-351"><span class="linenos">351</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fraction binding or neutralization retained after mutating indicated sites.</span>
</span><span id="EscapeCalculator.binding_retained-352"><a href="#EscapeCalculator.binding_retained-352"><span class="linenos">352</span></a>
</span><span id="EscapeCalculator.binding_retained-353"><a href="#EscapeCalculator.binding_retained-353"><span class="linenos">353</span></a><span class="sd">        Parameters</span>
</span><span id="EscapeCalculator.binding_retained-354"><a href="#EscapeCalculator.binding_retained-354"><span class="linenos">354</span></a><span class="sd">        ----------</span>
</span><span id="EscapeCalculator.binding_retained-355"><a href="#EscapeCalculator.binding_retained-355"><span class="linenos">355</span></a><span class="sd">        mutated_sites : array-like of integers</span>
</span><span id="EscapeCalculator.binding_retained-356"><a href="#EscapeCalculator.binding_retained-356"><span class="linenos">356</span></a><span class="sd">            List of mutated sites, must all be in :attr:`BindingCalculator.sites`.</span>
</span><span id="EscapeCalculator.binding_retained-357"><a href="#EscapeCalculator.binding_retained-357"><span class="linenos">357</span></a>
</span><span id="EscapeCalculator.binding_retained-358"><a href="#EscapeCalculator.binding_retained-358"><span class="linenos">358</span></a><span class="sd">        Returns</span>
</span><span id="EscapeCalculator.binding_retained-359"><a href="#EscapeCalculator.binding_retained-359"><span class="linenos">359</span></a><span class="sd">        -------</span>
</span><span id="EscapeCalculator.binding_retained-360"><a href="#EscapeCalculator.binding_retained-360"><span class="linenos">360</span></a><span class="sd">        float</span>
</span><span id="EscapeCalculator.binding_retained-361"><a href="#EscapeCalculator.binding_retained-361"><span class="linenos">361</span></a><span class="sd">            The fraction binding retained after these mutations.</span>
</span><span id="EscapeCalculator.binding_retained-362"><a href="#EscapeCalculator.binding_retained-362"><span class="linenos">362</span></a>
</span><span id="EscapeCalculator.binding_retained-363"><a href="#EscapeCalculator.binding_retained-363"><span class="linenos">363</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EscapeCalculator.binding_retained-364"><a href="#EscapeCalculator.binding_retained-364"><span class="linenos">364</span></a>        <span class="n">mutated_sites</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mutated_sites</span><span class="p">)</span>
</span><span id="EscapeCalculator.binding_retained-365"><a href="#EscapeCalculator.binding_retained-365"><span class="linenos">365</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">mutated_sites</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">):</span>
</span><span id="EscapeCalculator.binding_retained-366"><a href="#EscapeCalculator.binding_retained-366"><span class="linenos">366</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sites </span><span class="si">{</span><span class="n">mutated_sites</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="si">}</span><span class="s2"> not in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="EscapeCalculator.binding_retained-367"><a href="#EscapeCalculator.binding_retained-367"><span class="linenos">367</span></a>        <span class="n">retained</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="EscapeCalculator.binding_retained-368"><a href="#EscapeCalculator.binding_retained-368"><span class="linenos">368</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</span><span id="EscapeCalculator.binding_retained-369"><a href="#EscapeCalculator.binding_retained-369"><span class="linenos">369</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="EscapeCalculator.binding_retained-370"><a href="#EscapeCalculator.binding_retained-370"><span class="linenos">370</span></a>                <span class="n">mutated</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mutated_sites</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
</span><span id="EscapeCalculator.binding_retained-371"><a href="#EscapeCalculator.binding_retained-371"><span class="linenos">371</span></a>                <span class="n">site_bind_retain</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;escape&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;mutated&quot;</span><span class="p">],</span>
</span><span id="EscapeCalculator.binding_retained-372"><a href="#EscapeCalculator.binding_retained-372"><span class="linenos">372</span></a>            <span class="p">)</span>
</span><span id="EscapeCalculator.binding_retained-373"><a href="#EscapeCalculator.binding_retained-373"><span class="linenos">373</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;antibody&quot;</span><span class="p">,</span> <span class="s2">&quot;neg_log_ic50&quot;</span><span class="p">,</span> <span class="s2">&quot;reweight&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="EscapeCalculator.binding_retained-374"><a href="#EscapeCalculator.binding_retained-374"><span class="linenos">374</span></a>            <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">antibody_bind_retain</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="s2">&quot;site_bind_retain&quot;</span><span class="p">,</span> <span class="s2">&quot;prod&quot;</span><span class="p">))</span>
</span><span id="EscapeCalculator.binding_retained-375"><a href="#EscapeCalculator.binding_retained-375"><span class="linenos">375</span></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
</span><span id="EscapeCalculator.binding_retained-376"><a href="#EscapeCalculator.binding_retained-376"><span class="linenos">376</span></a>                <span class="n">antibody_bind_retain</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;antibody_bind_retain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span>
</span><span id="EscapeCalculator.binding_retained-377"><a href="#EscapeCalculator.binding_retained-377"><span class="linenos">377</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mut_escape_strength</span>
</span><span id="EscapeCalculator.binding_retained-378"><a href="#EscapeCalculator.binding_retained-378"><span class="linenos">378</span></a>                <span class="p">),</span>
</span><span id="EscapeCalculator.binding_retained-379"><a href="#EscapeCalculator.binding_retained-379"><span class="linenos">379</span></a>                <span class="n">weight</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span id="EscapeCalculator.binding_retained-380"><a href="#EscapeCalculator.binding_retained-380"><span class="linenos">380</span></a>                    <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;neg_log_ic50&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_by_neg_log_ic50</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="EscapeCalculator.binding_retained-381"><a href="#EscapeCalculator.binding_retained-381"><span class="linenos">381</span></a>                    <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;reweight&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="EscapeCalculator.binding_retained-382"><a href="#EscapeCalculator.binding_retained-382"><span class="linenos">382</span></a>                <span class="p">),</span>
</span><span id="EscapeCalculator.binding_retained-383"><a href="#EscapeCalculator.binding_retained-383"><span class="linenos">383</span></a>                <span class="n">weighted_antibody_bind_retain</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
</span><span id="EscapeCalculator.binding_retained-384"><a href="#EscapeCalculator.binding_retained-384"><span class="linenos">384</span></a>                    <span class="n">x</span><span class="p">[</span><span class="s2">&quot;antibody_bind_retain&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
</span><span id="EscapeCalculator.binding_retained-385"><a href="#EscapeCalculator.binding_retained-385"><span class="linenos">385</span></a>                <span class="p">),</span>
</span><span id="EscapeCalculator.binding_retained-386"><a href="#EscapeCalculator.binding_retained-386"><span class="linenos">386</span></a>            <span class="p">)</span>
</span><span id="EscapeCalculator.binding_retained-387"><a href="#EscapeCalculator.binding_retained-387"><span class="linenos">387</span></a>            <span class="p">[[</span><span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="s2">&quot;weighted_antibody_bind_retain&quot;</span><span class="p">]]</span>
</span><span id="EscapeCalculator.binding_retained-388"><a href="#EscapeCalculator.binding_retained-388"><span class="linenos">388</span></a>            <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="EscapeCalculator.binding_retained-389"><a href="#EscapeCalculator.binding_retained-389"><span class="linenos">389</span></a>        <span class="p">)</span>
</span><span id="EscapeCalculator.binding_retained-390"><a href="#EscapeCalculator.binding_retained-390"><span class="linenos">390</span></a>        <span class="k">return</span> <span class="n">retained</span><span class="p">[</span><span class="s2">&quot;weighted_antibody_bind_retain&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">retained</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Fraction binding or neutralization retained after mutating indicated sites.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>mutated_sites</strong> (array-like of integers):
List of mutated sites, must all be in <code>BindingCalculator.sites</code>.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>float</strong>: The fraction binding retained after these mutations.</li>
</ul>
</div>


                            </div>
                </section>
    </main>
</body>
</html>